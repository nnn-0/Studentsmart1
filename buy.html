<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="pU2v7x_qRVQ5j-A_JIVEKln6zIq_B4Jdjh122RCf4eQ" />
    <title>Browse Marketplace - StudentsMart</title>
    <link rel="icon" href="https://i.ibb.co/1YBpx2KS/logo.png">
    <!-- Add modern dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6C5CE7;
            --primary-light: #A29BFE;
            --secondary: #00CEC9;
            --accent: #FD79A8;
            --accent-light: #FFEAA7;
            --dark: #2D3436;
            --light: #F5F6FA;
            --white: #FFFFFF;
            --success: #00B894;
            --warning: #FDCB6E;
            --danger: #E17055;
            --border-radius: 12px;
            --border-radius-lg: 20px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.15);
            --blur: blur(10px);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background: var(--light);
            overflow-x: hidden;
            padding-top: 80px;
        }

        /* Navigation */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            padding: 1.2rem 0;
            transition: var(--transition);
            background: var(--white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 3rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }

        .navbar-brand {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            min-width: 200px;
        }

        .logo {
            height: 42px;
            transition: var(--transition);
        }

        .navbar-brand:hover .logo {
            transform: rotate(8deg) scale(1.1);
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
            min-height: calc(100vh - 80px);
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: var(--white);
            text-align: center;
            padding: 3rem 0;
            margin-bottom: 3rem;
        }

        .page-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .page-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Search and Filter Section */
        .search-section {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 3rem;
        }

        /* Listing Cards */
        .listing-card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            height: 100%;
        }

        .listing-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .listing-image {
            height: 200px;
            width: 100%;
            object-fit: cover;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .price-display {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .badge-container {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .seller-info {
            border-top: 1px solid #eee;
            padding-top: 0.75rem;
        }

        /* Loading Skeleton */
        .skeleton-card {
            border: 1px solid #e3e6f0;
            border-radius: var(--border-radius);
            padding: 1rem;
            background: var(--white);
        }

        .skeleton-image {
            height: 200px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--border-radius);
        }

        .skeleton-text {
            height: 1rem;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        /* Chat Button Styles - Matching Your Website Design */
        /* Chat Button Styles - Matching Your Website Design */
        .chat-button-container {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 1050;
        }

        #chatFloatingBtn {
            background: transparent;
            border: none;
            border-radius: 50%;
            padding: 0;
            box-shadow: none;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #chatFloatingBtn:hover {
            background: transparent;
            transform: translateY(-8px) scale(1.1);
            box-shadow: none;
        }

        #chatFloatingBtn img {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            object-fit: contain;
            background: transparent;
            padding: 10px;
        }

        #unreadMessageCount {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Mobile Responsive Styles */
        @media screen and (max-width: 768px) {
            .chat-button-container {
                right: 15px;
                bottom: 20px;
            }
            
            #chatFloatingBtn img {
                width: 130px;
                height: 130px;
                padding: 8px;
            }
            
            #chatFloatingBtn:hover {
                transform: translateY(-4px) scale(1.05);
            }
            
            #unreadMessageCount {
                min-width: 18px;
                height: 18px;
                font-size: 0.7rem;
                top: -3px;
                right: -3px;
            }
        }

        @media screen and (max-width: 480px) {
            .chat-button-container {
                right: 10px;
                bottom: 15px;
            }
            
            #chatFloatingBtn img {
                width: 110px;
                height: 110px;
                padding: 6px;
            }
            
            #chatFloatingBtn:hover {
                transform: translateY(-3px) scale(1.03);
            }
            
            #unreadMessageCount {
                min-width: 16px;
                height: 16px;
                font-size: 0.65rem;
                top: -2px;
                right: -2px;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            #chatFloatingBtn:hover {
                transform: none;
            }
            
            #chatFloatingBtn:active {
                transform: scale(0.95);
            }
        }
        /* ENHANCED CHAT MODAL STYLES - BIGGER AND MORE RESPONSIVE */
        /* Enhanced Responsive Chat Modal CSS */
        .modal-xl-custom {
            --bs-modal-width: 90vw;
            max-width: 1200px;
        }

        .chat-container {
            height: 85vh;
            max-height: 700px;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            background: var(--white);
            position: relative;
            display: flex;
        }

        /* Custom close button */
        .chat-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1060;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .chat-close-btn:hover {
            background: #f8f9fa;
            transform: scale(1.1);
        }

        .chat-close-btn i {
            color: #6c757d;
            font-size: 18px;
        }

        /* Mobile navigation for your existing structure */
        .mobile-chat-nav {
            display: none;
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1061;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #dee2e6;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .mobile-chat-nav:hover {
            background: #f8f9fa;
            transform: scale(1.1);
        }

        .mobile-chat-nav i {
            color: #6c757d;
            font-size: 18px;
        }

        .chat-sidebar {
            background: var(--light);
            border-right: 1px solid rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 350px;
            flex-shrink: 0;
        }

        .chat-sidebar-header {
            border-bottom: 1px solid rgba(0,0,0,0.1);
            background: var(--white);
            padding: 1.5rem;
            flex-shrink: 0;
            position: relative;
        }

        .chat-logo {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-list {
            overflow-y: auto;
            flex: 1;
            padding: 0.5rem;
        }

        .chat-item {
            padding: 1.25rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
            background: var(--white);
        }

        .chat-item:hover {
            background: rgba(108, 92, 231, 0.05);
            border-color: var(--primary-light);
            transform: translateX(2px);
        }

        .chat-item.active {
            background: rgba(108, 92, 231, 0.1);
            border-color: var(--primary);
            border-left: 4px solid var(--primary);
        }

        .chat-window {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--white);
            flex: 1;
            min-width: 0; /* Prevent flex item from overflowing */
        }

        .chat-header {
            border-bottom: 1px solid rgba(0,0,0,0.1);
            background: var(--white);
            padding: 1.5rem;
            flex-shrink: 0;
            position: relative;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f8f9fa;
        }

        .message-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 70%;
            padding: 1rem 1.25rem;
            border-radius: 1.25rem;
            position: relative;
            word-wrap: break-word;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-bottom-right-radius: 0.4rem;
            box-shadow: var(--shadow-sm);
        }

        .message.received {
            align-self: flex-start;
            background: var(--white);
            color: var(--dark);
            box-shadow: var(--shadow);
            border-bottom-left-radius: 0.4rem;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }

        .chat-input {
            padding: 1.5rem;
            border-top: 1px solid rgba(0,0,0,0.1);
            background: var(--white);
            flex-shrink: 0;
        }

        .chat-input .input-group {
            position: relative;
        }

        .chat-input .form-control {
            padding: 0.8rem 1rem;
            border-radius: 2rem;
            border: 2px solid rgba(0,0,0,0.1);
            font-size: 0.95rem;
            padding-right: 60px; /* Space for send button */
        }

        .chat-input .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(108, 92, 231, 0.25);
        }

        .chat-input .btn {
            padding: 0.8rem 1.2rem;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }

        .chat-empty-state {
            padding: 3rem 2rem;
            text-align: center;
            color: var(--dark);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .chat-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .user-avatar .rounded-circle {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Mobile sidebar backdrop for overlay */
        .chat-sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1050;
        }

        /* Tablet responsive (992px and below) */
        @media (max-width: 992px) {
            .modal-xl-custom {
                --bs-modal-width: 95vw;
            }
            
            .chat-sidebar {
                min-width: 300px;
            }
            
            .message {
                max-width: 80%;
            }
        }

        /* Mobile responsive (768px and below) */
        @media (max-width: 768px) {
            .modal-xl-custom {
                --bs-modal-width: 100vw;
                margin: 0 !important;
            }
            
            .modal-xl-custom .modal-content {
                border-radius: 0 !important;
                border: none;
                height: 100vh;
            }
            
            .chat-container {
                height: 100vh;
                max-height: none;
                border-radius: 0;
                position: relative;
            }
            
            .mobile-chat-nav {
                display: flex;
            }
            
            /* Mobile sidebar behavior - slides in from left */
            .chat-sidebar {
                position: absolute;
                top: 0;
                left: 0;
                width: 85%;
                max-width: 350px;
                height: 100%;
                z-index: 1055;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                box-shadow: 2px 0 15px rgba(0,0,0,0.2);
            }
            
            .chat-sidebar.show-mobile {
                transform: translateX(0);
            }
            
            .chat-sidebar-backdrop.show {
                display: block;
            }
            
            /* Chat window takes full width on mobile */
            .chat-window {
                width: 100%;
                height: 100%;
            }
            
            /* Adjust header padding for mobile nav */
            .chat-header {
                padding: 1rem 1.5rem;
                padding-left: 70px; /* Space for mobile nav button */
                padding-right: 60px; /* Space for close button */
            }
            
            .chat-sidebar-header {
                padding: 1rem 1.5rem;
                padding-right: 60px; /* Space for close button when sidebar is open */
            }
            
            .chat-close-btn {
                top: 12px;
                right: 12px;
                width: 36px;
                height: 36px;
            }
            
            .mobile-chat-nav {
                top: 12px;
                left: 12px;
                width: 36px;
                height: 36px;
            }
            
            .chat-messages {
                padding: 1rem;
                padding-bottom: 1.5rem;
            }
            
            .chat-input {
                padding: 1rem;
                padding-bottom: 1.5rem; /* Extra space at bottom for safe area */
            }
            
            .chat-input .form-control {
                padding: 0.9rem 1.1rem;
                padding-right: 60px;
                border-radius: 25px;
                font-size: 1rem;
            }
            
            .chat-input .btn {
                width: 45px;
                height: 45px;
                right: 8px;
            }
            
            .message {
                max-width: 85%;
                padding: 0.9rem 1.1rem;
                font-size: 0.95rem;
                border-radius: 18px;
            }
            
            .message.sent {
                border-bottom-right-radius: 6px;
            }
            
            .message.received {
                border-bottom-left-radius: 6px;
            }
            
            .message-time {
                font-size: 0.7rem;
                margin-top: 0.3rem;
            }
            
            .chat-item {
                padding: 1rem;
                margin-bottom: 0.3rem;
                border-radius: 12px;
            }
            
            .chat-list {
                padding: 0.5rem;
            }
            
            .user-avatar .rounded-circle {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
        }

        /* Small mobile devices (576px and below) */
        @media (max-width: 576px) {
            .chat-header {
                padding: 0.8rem 1rem;
                padding-left: 60px;
                padding-right: 50px;
            }
            
            .chat-sidebar-header {
                padding: 0.8rem 1rem;
                padding-right: 50px;
            }
            
            .chat-messages {
                padding: 0.8rem;
                padding-bottom: 1rem;
            }
            
            .chat-input {
                padding: 0.8rem;
                padding-bottom: 1.2rem;
            }
            
            .chat-input .form-control {
                padding: 0.8rem 1rem;
                padding-right: 55px;
                font-size: 0.95rem;
                border-radius: 22px;
            }
            
            .chat-input .btn {
                width: 42px;
                height: 42px;
                right: 6px;
            }
            
            .message {
                max-width: 90%;
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
                border-radius: 16px;
            }
            
            .chat-close-btn,
            .mobile-chat-nav {
                width: 32px;
                height: 32px;
                top: 10px;
            }
            
            .mobile-chat-nav {
                left: 10px;
            }
            
            .chat-close-btn {
                right: 10px;
            }
            
            .mobile-chat-nav i,
            .chat-close-btn i {
                font-size: 14px;
            }
            
            .chat-sidebar {
                width: 90%;
                min-width: 280px;
            }
        }

        /* Extra small devices (400px and below) */
        @media (max-width: 400px) {
            .chat-header,
            .chat-sidebar-header {
                padding: 0.7rem;
                padding-left: 55px;
                padding-right: 50px;
            }
            
            .chat-messages {
                padding: 0.7rem;
            }
            
            .chat-input {
                padding: 0.7rem;
                padding-bottom: 1rem;
            }
            
            .message {
                max-width: 95%;
                padding: 0.7rem 0.9rem;
                font-size: 0.85rem;
            }
            
            .chat-item {
                padding: 0.8rem;
            }
            
            .chat-sidebar {
                width: 95%;
                min-width: 260px;
            }
        }

        /* Additional utility styles */
        .online-status {
            color: var(--success);
            font-weight: 500;
        }

        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Smooth animations for mobile transitions */
        @media (max-width: 768px) {
            .chat-container * {
                transition: all 0.3s ease;
            }
            
            /* Handle hardware back button and navigation */
            .modal.show {
                animation: modalSlideIn 0.3s ease-out;
            }
            
            .modal.fade:not(.show) {
                animation: modalSlideOut 0.3s ease-in;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes modalSlideOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(100%);
            }
        }
        
        /* Horizontal Card Layout Styles */
        
        
        /* Report Modal Styles - Matching Your Design System */

/* Modal Backdrop and Container */
/* Report Modal - Simple & Clean */
/* Report Modal - Very Simple */
/* Report Modal - Very Simple */
        .report-modal .modal-content {
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
        }

        .report-modal .modal-header {
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            padding: 1rem 1.5rem;
        }

        .report-modal .modal-title {
            font-size: 1.1rem;
            color: var(--dark);
        }

        .report-modal .btn-close {
            font-size: 1.2rem;
        }

        .report-modal .modal-body {
            padding: 1.5rem;
        }

        .report-form .form-label {
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .report-form .form-control {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 0.75rem;
        }

        .report-form .form-control:focus {
            border-color: #999;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
        }

        .report-form textarea {
            min-height: 100px;
        }

        .report-preview-image {
            max-width: 100%;
            max-height: 120px;
            margin-top: 0.5rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }

        .report-form .btn-primary {
            background: var(--primary);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            color: var(--white);
        }

        .report-form .btn-primary:hover {
            background: var(--primary-light);
        }

        @media (max-width: 768px) {
            .report-modal .modal-dialog {
                margin: 1rem;
            }
        }
        .step-progress {
            margin-bottom: 2rem;
        }

        .step-progress-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .step-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 2px;
            width: 20%;
            transition: width 0.3s ease;
        }

        .step-indicators {
            display: flex;
            justify-content: space-between;
        }

        .step-indicator {
            text-align: center;
            flex: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step-indicator.active .step-number {
            background: var(--primary);
            color: white;
        }

        .step-indicator.completed .step-number {
            background: var(--success);
            color: white;
        }

        .step-title {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 500;
        }

        .step-indicator.active .step-title {
            color: var(--primary);
            font-weight: 600;
        }

        .step-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .step-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .step-header h4 {
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .step-navigation {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Image Upload Styles */
        .image-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .image-upload-area:hover {
            border-color: var(--primary);
            background: rgba(108, 92, 231, 0.05);
        }

        .image-upload-label {
            display: block;
            cursor: pointer;
            margin: 0;
        }

        .upload-placeholder {
            padding: 3rem 2rem;
            text-align: center;
        }

        .preview-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
        }

        .image-actions {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        #imagePreviewContainer {
            position: relative;
        }
        /* Compact Horizontal Card Layout */
        .listing-card-horizontal-clean {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            overflow: hidden;
            height: 240px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .listing-card-horizontal-clean:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-color: var(--primary);
            outline-color: rgba(108, 92, 231, 0.3);
        }

        /* Image Section - Left Side */
        .listing-image-section {
            position: relative;
            height: 100%;
            overflow: hidden;
        }

        .listing-image-pro {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .listing-card-horizontal-clean:hover .listing-image-pro {
            transform: scale(1.05);
        }

        .listing-badges-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .badge-category,
        .badge-rental,
        .badge-digital {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-transform: capitalize;
        }

        .badge-category {
            background: rgba(108, 92, 231, 0.9);
        }

        .badge-rental {
            background: rgba(253, 121, 168, 0.9);
        }

        .badge-digital {
            background: rgba(74, 144, 226, 0.9);
        }

        /* Content Section - Right Side */
        .listing-content-section {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .content-top {
            flex-grow: 1;
            margin-bottom: 15px;
        }

        .content-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .listing-title-pro {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 12px;
            line-height: 1.4;
            display: -webkit-box;
            --webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            max-height: 3.4em;
        }

        /* Details Section */
        .listing-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .detail-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .detail-row i {
            width: 14px;
            color: var(--gray-medium);
            font-size: 0.8rem;
        }

        .detail-text {
            color: var(--gray-dark);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        /* Price Section */
        .listing-price-section {
            flex-shrink: 0;
        }

        .price-display {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .price-period {
            font-size: 0.85rem;
            color: var(--gray-medium);
            font-weight: 500;
        }

        .price-original {
            text-decoration: line-through;
            color: var(--gray-medium);
            margin-right: 8px;
            font-size: 1rem;
        }

        .price-free {
            color: var(--success);
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Actions Section */
        .listing-actions-section {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
            min-width: 0;
        }

        .btn-primary-action {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: var(--transition);
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
            max-width: none;
        }

        .btn-primary-action:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            color: white;
        }

        .btn-secondary-action {
            width: 40px;
            height: 40px;
            background: rgba(225, 112, 85, 0.1);
            color: var(--danger);
            border: 1px solid rgba(225, 112, 85, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            cursor: pointer;
            flex-shrink: 0;
            font-size: 1rem;
        }

        .btn-secondary-action:hover {
            background: rgba(225, 112, 85, 0.2);
            transform: translateY(-2px);
        }

        /* Responsive Design - 3 Cards Per Row */
        @media (max-width: 1199px) {
            .listing-card-horizontal-clean {
                height: 220px;
            }
            
            .listing-title-pro {
                font-size: 1.1rem;
                margin-bottom: 10px;
            }
            
            .listing-content-section {
                padding: 18px;
            }
            
            .detail-row {
                font-size: 0.8rem;
            }
            
            .price-display {
                font-size: 1.3rem;
            }
            
            .btn-primary-action {
                padding: 9px 15px;
                font-size: 0.85rem;
            }
            
            .btn-secondary-action {
                width: 36px;
                height: 36px;
            }
        }

        @media (max-width: 991px) {
            .listing-card-horizontal-clean {
                height: 200px;
            }
            
            .listing-title-pro {
                font-size: 1rem;
                --webkit-line-clamp: 2;
                max-height: 2.8em;
                margin-bottom: 8px;
            }
            
            .listing-content-section {
                padding: 16px;
            }
            
            .detail-row {
                font-size: 0.75rem;
                gap: 6px;
            }
            
            .detail-row i {
                width: 12px;
                font-size: 0.75rem;
            }
            
            .price-display {
                font-size: 1.2rem;
            }
            
            .btn-primary-action {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .btn-secondary-action {
                width: 34px;
                height: 34px;
            }
            
            .content-bottom {
                gap: 15px;
            }
        }

        @media (max-width: 767px) {
            /* 2 cards per row on tablets */
            .listing-card-horizontal-clean {
                height: 180px;
            }
            
            .listing-content-section {
                padding: 14px;
            }
            
            .listing-title-pro {
                font-size: 0.95rem;
            }
            
            .content-bottom {
                gap: 12px;
            }
        }

        @media (max-width: 575px) {
            /* Keep horizontal layout on mobile - same as desktop */
            .listing-card-horizontal-clean {
                height: 200px;
                margin-bottom: 15px;
            }
            
            /* Keep the horizontal row layout */
            .listing-card-horizontal-clean .row {
                flex-direction: row;
            }
            
            .listing-card-horizontal-clean .col-4,
            .listing-card-horizontal-clean .col-8 {
                flex: 0 0 auto;
                width: 33.333333%;
            }
            
            .listing-card-horizontal-clean .col-8 {
                width: 66.666667%;
            }
            
            /* Image section - left side */
            .listing-image-section {
                height: 100%;
                width: 100%;
            }
            
            .listing-content-section {
                height: 100%;
                padding: 12px;
            }
            
            .content-bottom {
                flex-direction: row;
                align-items: center;
                gap: 8px;
                margin-top: 0;
            }
            
            .listing-actions-section {
                justify-content: flex-end;
                gap: 6px;
            }
            
            .btn-primary-action {
                padding: 8px 12px;
                font-size: 0.8rem;
                gap: 4px;
            }
            
            .btn-secondary-action {
                width: 36px;
                height: 36px;
            }
            
            .listing-title-pro {
                font-size: 0.95rem;
                margin-bottom: 8px;
                --webkit-line-clamp: 2;
                max-height: 2.8em;
            }
            
            .detail-row {
                font-size: 0.75rem;
                gap: 6px;
            }
            
            .detail-row i {
                width: 12px;
                font-size: 0.7rem;
            }
            
            .price-display {
                font-size: 1.1rem;
                text-align: left;
                margin-bottom: 0;
            }
        }

        /* General utility classes */
        .price-crossed {
            text-decoration: line-through;
            color: #999;
            margin-right: 10px;
        }

        .free-price {
            color: #28a745;
            font-weight: bold;
            margin-right: 6px;
        }

        .digital-note {
            font-size: 0.85em;
            color: #6c757d;
            margin-left: 6px;
        }
        /* Review Card */
        .review-card {
            background: var(--light);
            padding: 2rem;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
        }

        .review-image img {
            border-radius: var(--border-radius);
            max-height: 200px;
            width: 100%;
            object-fit: cover;
        }

        .review-meta {
            margin: 1rem 0;
        }

        .review-meta .badge {
            margin-right: 0.5rem;
        }

        .review-price h4 {
            font-weight: 700;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .step-indicators {
                gap: 0.5rem;
            }
            
            .step-number {
                width: 32px;
                height: 32px;
                font-size: 0.875rem;
            }
            
            .step-title {
                font-size: 0.75rem;
            }
            
            .upload-placeholder {
                padding: 2rem 1rem;
            }
            
            .step-navigation {
                flex-direction: column-reverse;
                gap: 0.5rem;
            }
            
            .step-navigation button {
                width: 100%;
            }
        }

        /* Form Control Enhancements */
        .form-control-lg, .form-select-lg {
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
        }

        .btn-group .btn-check:checked + .btn {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        /* Category Navigation Styles */
        .category-nav-section {
            background: var(--white);
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .category-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            max-width: 1000px;
            margin: 0 auto;
        }

        .category-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 2rem 1.5rem;
            background: var(--white);
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius-lg);
            text-decoration: none;
            color: var(--dark);
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .category-btn:hover {
            border-color: var(--primary);
            background: rgba(108, 92, 231, 0.05);
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            color: var(--primary);
        }

        .category-btn.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .category-btn i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .category-btn span {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .category-btn small {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .category-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .category-btn {
                padding: 1.5rem 1rem;
            }
            
            .category-btn i {
                font-size: 2rem;
            }
            
            .category-btn span {
                font-size: 1rem;
            }
        }
        .breadcrumb-nav {
            background: var(--white);
            padding: 1rem 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 2rem;
        }

        .breadcrumb {
            background: none;
            margin: 0;
        }

        .breadcrumb-item a {
            color: var(--primary);
            text-decoration: none;
        }
        /* ============================================
   MODERN MOBILE MENU STYLES
   ============================================ */

/* Custom Hamburger Button */
        /* ============================================
   MODERN MOBILE MENU - FIXED VERSION
   ============================================ */

/* Custom Hamburger Button */
        /* ============================================
   MODERN MOBILE MENU - SPACIOUS VERSION
   ============================================ */

        .navbar-toggler {
            border: none;
            padding: 0.5rem;
            background: transparent;
            position: relative;
            z-index: 1001;
            display: none;
        }

        .navbar-toggler:focus {
            box-shadow: none;
            outline: none;
        }

        .navbar-toggler-icon {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 26px;
            cursor: pointer;
            background-image: none !important;
        }

        .navbar-toggler-icon span {
            width: 26px;
            height: 3px;
            background: var(--dark);
            border-radius: 3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: block;
        }

        /* Animated Hamburger to X */
        .navbar-toggler.active .navbar-toggler-icon span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .navbar-toggler.active .navbar-toggler-icon span:nth-child(2) {
            opacity: 0;
            transform: translateX(20px);
        }

        .navbar-toggler.active .navbar-toggler-icon span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        /* Backdrop Overlay */
        .mobile-menu-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-menu-backdrop.show {
            display: block;
            opacity: 1;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 991px) {
            /* Show hamburger */
            .navbar-toggler {
                display: flex;
            }

            /* Hide desktop auth buttons on mobile */
            #authButtons {
                display: none !important;
            }

            /* Mobile Sidebar - MORE SPACIOUS */
            #navbarNav {
                position: fixed;
                top: 0;
                right: -100%;
                width: 320px; /* Increased from 280px */
                max-width: 85vw;
                height: 100vh;
                background: var(--white);
                box-shadow: -5px 0 30px rgba(0, 0, 0, 0.2);
                transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 999;
                overflow-y: auto;
                display: flex !important;
                flex-direction: column;
                padding: 0;
            }

            #navbarNav.show {
                right: 0;
            }

            /* Mobile Menu Header - MORE SPACIOUS */
            .mobile-menu-header {
                background: linear-gradient(135deg, #6C5CE7 0%, #A29BFE 100%);
                padding: 1.75rem 1.25rem; /* Increased padding */
                color: var(--white);
                display: flex;
                flex-direction: column;
                gap: 1rem; /* Increased gap */
                box-shadow: 0 2px 10px rgba(108, 92, 231, 0.2);
                flex-shrink: 0;
            }

            .mobile-menu-close {
                align-self: flex-end;
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: var(--white);
                width: 36px; /* Slightly bigger */
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: var(--transition);
                font-size: 1.2rem;
                padding: 0;
                margin: 0;
            }

            .mobile-menu-close:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: rotate(90deg);
            }

            /* User Profile Section - MORE SPACIOUS */
            .mobile-user-section {
                display: flex;
                align-items: center;
                gap: 1rem; /* Increased gap */
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(10px);
                padding: 1rem; /* Increased padding */
                border-radius: 12px;
            }

            .mobile-user-avatar {
                width: 50px; /* Increased from 42px */
                height: 50px;
                min-width: 50px;
                border-radius: 50%;
                background: var(--white);
                color: var(--primary);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.4rem; /* Larger text */
                font-weight: 700;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .mobile-user-info {
                flex: 1;
                overflow: hidden;
            }

            .mobile-user-name {
                font-weight: 600;
                font-size: 1rem; /* Slightly bigger */
                margin-bottom: 0.2rem;
                color: var(--white);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .mobile-user-email {
                font-size: 0.8rem;
                opacity: 0.9;
                color: var(--white);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Auth Buttons - MORE SPACIOUS */
            .mobile-auth-section {
                display: flex;
                flex-direction: column;
                gap: 0.75rem; /* Increased gap */
            }

            .mobile-auth-section .btn {
                width: 100%;
                padding: 0.85rem; /* Increased padding */
                border-radius: 10px;
                font-weight: 600;
                font-size: 0.9rem; /* Slightly bigger */
                transition: var(--transition);
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }

            .mobile-auth-section .btn-outline-primary {
                background: rgba(255, 255, 255, 0.15);
                border: 2px solid var(--white);
                color: var(--white);
            }

            .mobile-auth-section .btn-outline-primary:hover {
                background: rgba(255, 255, 255, 0.25);
            }

            .mobile-auth-section .btn-primary {
                background: var(--white);
                color: var(--primary);
                border: none;
            }

            .mobile-auth-section .btn-primary:hover {
                box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
            }

            /* Navigation List - MORE SPACIOUS */
            .navbar-nav {
                padding: 1rem 0; /* Increased padding */
                flex-direction: column;
                gap: 0;
                margin: 0;
                flex: 1;
                overflow-y: auto;
            }

            .nav-item {
                margin: 0;
                border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            }

            .nav-item:last-child {
                border-bottom: none;
            }

            .nav-link {
                display: flex;
                align-items: center;
                gap: 1rem; /* Increased gap */
                padding: 1.15rem 1.25rem; /* More padding */
                color: var(--dark);
                font-weight: 500;
                font-size: 0.95rem; /* Slightly bigger */
                transition: var(--transition);
                position: relative;
                text-decoration: none;
            }

            .nav-link::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 0;
                background: var(--primary);
                transition: width 0.3s ease;
            }

            .nav-link:hover,
            .nav-link:active {
                background: rgba(108, 92, 231, 0.08);
                color: var(--primary);
                text-decoration: none;
            }

            .nav-link:hover::before {
                width: 4px; /* Thicker line */
            }

            .nav-link i {
                font-size: 1.2rem; /* Bigger icons */
                width: 24px;
                text-align: center;
                transition: var(--transition);
            }

            .nav-link:hover i {
                transform: scale(1.15);
            }

            /* Badge Styling */
            .nav-link .badge,
            #navReportsBadge {
                margin-left: auto;
                background: var(--danger);
                color: var(--white);
                padding: 0.3rem 0.6rem; /* More padding */
                border-radius: 12px;
                font-size: 0.7rem;
                font-weight: 700;
            }

            /* Notification Badge */
            #notificationBadge {
                position: static !important;
                transform: none !important;
                margin-left: auto;
            }

            /* Dropdown Menu - MORE SPACIOUS */
            .nav-item.dropdown .dropdown-toggle::after {
                margin-left: auto;
                transition: transform 0.3s ease;
            }

            .dropdown-menu {
                position: static !important;
                transform: none !important;
                border: none;
                background: #f8f9fa;
                box-shadow: none;
                margin: 0;
                padding: 0.5rem 0; /* More padding */
                border-radius: 0;
            }

            .dropdown-item {
                padding: 1rem 1.25rem 1rem 3rem; /* More padding */
                color: var(--dark);
                font-size: 0.9rem; /* Slightly bigger */
                transition: var(--transition);
                position: relative;
            }

            .dropdown-item::before {
                content: '';
                position: absolute;
                left: 2rem;
                top: 50%;
                transform: translateY(-50%);
                color: var(--primary);
                opacity: 0;
                transition: var(--transition);
                font-size: 1.1rem;
            }

            .dropdown-item:hover {
                background: rgba(108, 92, 231, 0.08);
                color: var(--primary);
            }

            .dropdown-item:hover::before {
                opacity: 1;
            }

            .dropdown-item i {
                margin-right: 0.75rem;
                width: 18px;
                text-align: center;
                font-size: 0.9rem;
            }

            .dropdown-divider {
                margin: 0.5rem 1.25rem; /* More margin */
                opacity: 0.5;
            }

            /* Scrollbar */
            #navbarNav::-webkit-scrollbar {
                width: 4px; /* Slightly thicker */
            }

            #navbarNav::-webkit-scrollbar-thumb {
                background: rgba(108, 92, 231, 0.3);
                border-radius: 4px;
            }
        }

        /* Tablet Adjustments */
        @media (max-width: 768px) {
            #navbarNav {
                width: 300px;
            }
        }

        /* Small Mobile */
        @media (max-width: 480px) {
            #navbarNav {
                width: 280px;
            }

            .mobile-menu-header {
                padding: 1.5rem 1rem;
            }

            .nav-link {
                padding: 1rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* Prevent body scroll */
        body.menu-open {
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/" style="flex-grow: 1; max-width: 400px;">
                <div class="logo-container">
                    <img src="https://i.ibb.co/Z05RbY8/logo-removebg-preview-5.png"
                        alt="StudentsMart - Learn.Sell.Repeat" 
                        class="logo">
                </div>
            </a>
            
            <!-- UPDATED: Modern Hamburger Button -->
            <button class="navbar-toggler" type="button" onclick="toggleMobileMenu()">
                <div class="navbar-toggler-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
            
            <!-- UPDATED: Mobile Menu with Header -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- Mobile Menu Header (Only visible on mobile) -->
                

                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home me-2"></i>Home
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="handlePathSelection('sell')">
                            <i class="fas fa-plus me-2"></i>Create Listing
                        </a>
                    </li>
                    
                    <li class="nav-item"><a class="nav-link" href="books.html"><i class="fas fa-book me-2"></i>Books</a></li>
                    <li class="nav-item"><a class="nav-link" href="electronics.html"><i class="fas fa-laptop me-2"></i>Electronics</a></li>
                    <li class="nav-item"><a class="nav-link" href="clothes.html"><i class="fas fa-tshirt me-2"></i>Clothes</a></li>
                                        
                    <li class="nav-item dropdown d-none" id="adminMenu">
                        <a class="nav-link" href="#" onclick="showAdminDashboard()">
                            <i class="fas fa-tools me-2"></i>Admin Dashboard
                        </a>
                    </li>
                    <li class="nav-item d-none" id="reportsMenu">
                        <a class="nav-link" href="#" onclick="showAdminDashboard('reports')">
                            <i class="fas fa-flag me-2"></i>Reports
                            <span class="badge bg-danger" id="navReportsBadge">0</span>
                        </a>
                    </li>
                    <li class="nav-item" id="authButtons">
                        <button class="btn btn-outline-primary me-2" onclick="showLoginModal()">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                        <button class="btn btn-primary" onclick="showRegisterModal()">
                            <i class="fas fa-user-plus me-2"></i>Register
                        </button>
                    </li>
                    <li class="nav-item d-none" id="notificationMenu">
                        <a class="nav-link position-relative" href="/notifications">
                            <i class="fas fa-bell"></i>
                            <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                                0
                            </span>
                            Notifications
                        </a>
                    </li>
                    <li class="nav-item dropdown d-none" id="userMenu">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-2"></i><span id="userName"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showMyListings()">
                                <i class="fas fa-list me-2"></i>My Listings
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="showWishlist()">
                                <i class="fas fa-heart me-2"></i>Wishlist
                            </a></li>
                            <li><a class="dropdown-item" href="/profiledashboard"><i class="fas fa-user me-2"></i>Profile Dashboard</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    

    <!-- Floating Chat Button -->
    <div class="chat-button-container">
        <button id="chatFloatingBtn" onclick="showChatModal()" title="Open Chat">
            <img src="https://i.ibb.co/8gwcF4q4/chat-removebg-preview.png" alt="Chat" />
            <span id="unreadMessageCount" style="display: none;">0</span>
        </button>
    </div>
    <!-- Breadcrumb -->
    <div class="breadcrumb-nav">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i> Home</a></li>
                    <li class="breadcrumb-item active">All Marketplace</li>
                </ol>
            </nav>
        </div>
    </div>
    <!-- Main Content -->
    <div class="container main-content">
        <!-- Search and Filter Section -->
         <!-- Category Navigation -->
        <div class="category-nav-section">
            <div class="container">
                <div class="row g-3 mb-4">
                    <div class="col-12">
                        <h2 class="text-center mb-4">Browse by Category</h2>
                        <div class="category-buttons">
                            
                            <a href="books.html" class="category-btn">
                                <i class="fas fa-book"></i>
                                <span>Books</span>
                                <small>Textbooks & Notes</small>
                            </a>
                            <a href="electronics.html" class="category-btn">
                                <i class="fas fa-laptop"></i>
                                <span>Electronics</span>
                                <small>Gadgets & Tech</small>
                            </a>
                            <a href="clothes.html" class="category-btn">
                                <i class="fas fa-tshirt"></i>
                                <span>Clothes</span>
                                <small>Fashion & Apparel</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-section">
            <h1 Latest Items></h1>

        <!-- Listings Grid -->
        <div class="row g-4" id="listingsGrid">
            <!-- Listings will be dynamically added here -->
        </div>

        <!-- Loading Skeleton -->
        <div class="row g-4" id="loadingSkeleton" style="display: none;">
            <!-- Skeleton cards will be added here -->
        </div>
    </div>

    <!-- Enhanced Chat Modal -->
    <div class="modal fade" id="chatModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl-custom modal-dialog-centered">
            <div class="modal-content chat-container">
                <!-- Mobile Menu Toggle Button -->
                <button type="button" class="mobile-chat-nav" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>

                <!-- Custom Close Button -->
                <button type="button" class="chat-close-btn" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
                
                <!-- Sidebar Backdrop for Mobile -->
                <div class="chat-sidebar-backdrop" id="sidebarBackdrop"></div>
                
                <div class="row g-0 h-100">
                    <!-- Left Sidebar -->
                    <div class="col-4 chat-sidebar" id="chatSidebar">
                        <div class="chat-sidebar-header">
                            <div class="d-flex align-items-center mb-3">
                                <div class="user-avatar me-3">
                                    <img src="https://i.ibb.co/1YBpx2KS/logo.png" alt="StudentsMart" class="chat-logo">
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="mb-0" id="currentUserName">Your Account</h5>
                                    <small class="online-status">Online</small>
                                </div>
                            </div>
                            <div class="search-box">
                                <div class="input-group">
                                    <span class="input-group-text border-0 bg-light">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0 bg-light" 
                                        placeholder="Search conversations" id="chatSearch">
                                </div>
                            </div>
                        </div>
                        <div class="chat-list" id="chatList">
                            <!-- Default message when no chats -->
                            <div class="text-center text-muted p-4" id="noChatMessage">
                                <i class="fas fa-comments fa-3x mb-3 opacity-50"></i>
                                <h6>No conversations yet</h6>
                                <p class="small mb-0">Start by contacting a seller!</p>
                                <small class="text-muted">Messages will appear here</small>
                            </div>
                        </div>
                    </div>

                    <!-- Right Chat Window -->
                    <div class="col-8 chat-window" id="chatWindow">
                        <!-- Empty state -->
                        <div class="chat-empty-state" id="chatEmptyState">
                            <i class="fas fa-comments fa-4x mb-3 text-muted"></i>
                            <h4>Welcome to Messages</h4>
                            <p class="text-muted mb-0">Select a conversation to start chatting with fellow students</p>
                            <small class="text-muted">Connect with sellers and buyers securely</small>
                        </div>

                        <!-- Chat content -->
                        <div class="chat-content" id="chatContent" style="display: none;">
                            <div class="chat-header">
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar me-3">
                                        <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                                            style="width: 45px; height: 45px; color: white; font-weight: bold;" id="chatContactAvatar">
                                            U
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h5 class="mb-0" id="chatContactName">User</h5>
                                        <small class="text-muted">
                                            <span class="online-status">
                                                <i class="fas fa-circle text-success me-1" style="font-size: 0.6rem;"></i>
                                                online
                                            </span>
                                        </small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary btn-sm d-none d-md-inline-flex">
                                            <i class="fas fa-user me-1"></i> Profile
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" id="markSoldBtn" onclick="showChatSoldModal()" style="display: none;">
                                            <i class="fas fa-check-circle me-1"></i> Mark Sold
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" id="reportBtn" onclick="showReportModal()">
                                            <i class="fas fa-flag me-1"></i> Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-messages" id="chatMessages">
                                <div class="message-container">
                                    <!-- Messages will be loaded dynamically -->
                                </div>
                            </div>
                            <div class="chat-input">
                                <div class="input-group">
                                    <input type="text" 
                                        class="form-control" 
                                        id="messageInput" 
                                        placeholder="Type a message"
                                        autocomplete="off">
                                    <button class="btn btn-primary" id="sendMessage">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Mark as Sold Modal in Chat -->
    <div class="modal fade" id="chatSoldModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mark as Sold</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="chatSoldForm">
                        <input type="hidden" id="chatListingId" name="listing_id">
                        <div class="mb-3">
                            <label for="chatBuyerName" class="form-label">Buyer Name*</label>
                            <input type="text" id="chatBuyerName" class="form-control" name="buyer_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="chatBuyerEmail" class="form-label">Buyer Email*</label>
                            <input type="email" id="chatBuyerEmail" class="form-control" name="buyer_email" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="markAsSoldFromChat()">Send Confirmation</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade report-modal" id="reportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report User</h5>
                    <button type="button" class="btn-close" onclick="closeReportModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="reportForm" class="report-form">
                        <input type="hidden" id="reportListingId">
                        <input type="hidden" id="reportMessageThreadId">
                        <div class="mb-3">
                            <label for="reportDescription" class="form-label">Describe why you are reporting this user</label>
                            <textarea class="form-control" id="reportDescription" rows="4" required placeholder="Explain the issue with this user or conversation..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="reportImage" class="form-label">Add supporting image (optional)</label>
                            <input type="file" class="form-control" id="reportImage" accept="image/*">
                            <img id="reportPreviewImage" class="report-preview-image d-none">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Submit Report</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Listing Modal -->
    <div class="modal fade" id="createListingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <div class="w-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="modal-title">Create New Listing</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        
                        <!-- Step Progress Indicator -->
                        <div class="step-progress">
                            <div class="step-progress-bar">
                                <div class="step-progress-fill" id="progressBar"></div>
                            </div>
                            <div class="step-indicators">
                                <div class="step-indicator active" data-step="1">
                                    <div class="step-number">1</div>
                                    <div class="step-title">Category</div>
                                </div>
                                <div class="step-indicator" data-step="2">
                                    <div class="step-number">2</div>
                                    <div class="step-title">Details</div>
                                </div>
                                <div class="step-indicator" data-step="3">
                                    <div class="step-number">3</div>
                                    <div class="step-title">Pricing</div>
                                </div>
                                <div class="step-indicator" data-step="4">
                                    <div class="step-number">4</div>
                                    <div class="step-title">Image</div>
                                </div>
                                <div class="step-indicator" data-step="5">
                                    <div class="step-number">5</div>
                                    <div class="step-title">Review</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-body">
                    <form id="createListingForm" enctype="multipart/form-data">
                        <!-- Step 1: Category Selection -->
                        <div class="step-content active" data-step="1">
                            <div class="step-header">
                                <h4>Choose Your Category</h4>
                                <p class="text-muted">Select the category that best describes your item</p>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Category *</label>
                                    <select class="form-select form-select-lg" name="category" id="listingCategory" required>
                                        <option value="">Select Category</option>
                                        <option value="electronic"> Electronics</option>
                                        <option value="books"> Books</option>
                                        <option value="clothes"> Clothes</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Product Type *</label>
                                    <select class="form-select form-select-lg" name="product_type" id="productType" required>
                                        <option value="">Select Product Type</option>
                                    </select>
                                </div>

                                <div class="col-12">
                                    <label for="academicYear" class="form-label">Academic Year *</label>
                                    <select class="form-select form-select-lg" id="academicYear" name="study_year" required>
                                        <option value="" selected disabled>Select Academic Year</option>
                                        <option value="1"> 1st Year</option>
                                        <option value="2"> 2nd Year</option>
                                        <option value="3"> 3rd Year</option>
                                        <option value="4"> 4th Year</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Details -->
                        <div class="step-content" data-step="2">
                            <div class="step-header">
                                <h4>Product Details</h4>
                                <p class="text-muted">Provide detailed information about your item</p>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Title *</label>
                                    <input type="text" class="form-control form-control-lg" name="title" 
                                        placeholder="Enter a descriptive title for your item" required>
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Description *</label>
                                    <textarea class="form-control" name="description" rows="4" 
                                            placeholder="Describe your item's condition, features, and any other relevant details..." required></textarea>
                                </div>

                                <!-- Conditional fields that will be shown based on category -->
                                <div class="col-md-6 field-branch" style="display: none;">
                                    <label class="form-label">Branch</label>
                                    <select class="form-select" name="branch">
                                        <option value="">Select Branch</option>
                                        <option value="CSE">CSE</option>
                                        <option value="ECE">ECE</option>
                                        <option value="EEE">EEE</option>
                                        <option value="MECH">MECH</option>
                                        <option value="CIVIL">CIVIL</option>
                                    </select>
                                </div>

                                <div class="col-md-6 field-faculty" style="display: none;">
                                    <label class="form-label">Faculty Name</label>
                                    <input type="text" class="form-control" name="faculty_name" placeholder="Enter faculty name">
                                </div>

                                <div class="col-md-6 field-subject" style="display: none;">
                                    <label class="form-label">Subject</label>
                                    <input type="text" class="form-control" name="subject" placeholder="Enter subject">
                                </div>

                                <div class="col-md-6 field-softcopy" style="display: none;">
                                    <label class="form-label">Copy Type</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="copy_type" id="softCopy" value="soft">
                                        <label class="btn btn-outline-primary" for="softCopy"> Soft Copy</label>
                                        
                                        <input type="radio" class="btn-check" name="copy_type" id="hardCopy" value="hard" checked>
                                        <label class="btn btn-outline-primary" for="hardCopy"> Hard Copy</label>
                                    </div>
                                </div>

                                <div class="col-12 field-fileupload" style="display: none;">
                                    <label class="form-label">Upload PDF/Document</label>
                                    <input type="file" class="form-control" name="document" accept=".pdf,.doc,.docx">
                                </div>

                                <div class="col-md-6 field-working-condition" style="display: none;">
                                    <label class="form-label">Working Condition</label>
                                    <select class="form-select" name="working_condition">
                                        <option value="">Select Condition</option>
                                        <option value="Fully functional"> Fully functional</option>
                                        <option value="Needs repair"> Needs repair</option>
                                    </select>
                                </div>

                                <div class="col-md-6 field-warranty" style="display: none;">
                                    <label class="form-label">Warranty Status</label>
                                    <select class="form-select" name="warranty_status">
                                        <option value="">Select Warranty Status</option>
                                        <option value="No"> No Warranty</option>
                                        <option value="Yes"> Under Warranty</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Pricing -->
                        <div class="step-content" data-step="3">
                            <div class="step-header">
                                <h4>Set Your Price</h4>
                                <p class="text-muted">Choose how you want to sell your item</p>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Listing Type *</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="listing_type" id="sellType" value="sell" checked>
                                        <label class="btn btn-outline-success btn-lg" for="sellType">
                                            <i class="fas fa-tags me-2"></i>Sell
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="listing_type" id="rentType" value="rent">
                                        <label class="btn btn-outline-info btn-lg" for="rentType">
                                            <i class="fas fa-clock me-2"></i>Rent
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-12" id="sellPriceField">
                                    <label class="form-label">Selling Price () *</label>
                                    <input type="number" class="form-control form-control-lg" name="price" 
                                        placeholder="Enter selling price" min="0" required>
                                </div>
                                
                                <div class="col-md-6 rent-field" id="rentPriceField" style="display: none;">
                                    <label class="form-label">Rental Price (/day) *</label>
                                    <input type="number" class="form-control" name="rent_price" 
                                        placeholder="Daily rental rate" min="0">
                                </div>
                                
                                <div class="col-md-6 rent-field" id="rentTenureField" style="display: none;">
                                    <label class="form-label">Maximum Rental Days *</label>
                                    <input type="number" class="form-control" name="rent_tenure" 
                                        placeholder="Maximum rental period" min="1">
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Image Upload -->
                        <div class="step-content" data-step="4">
                            <div class="step-header">
                                <h4>Add Product Image</h4>
                                <p class="text-muted">Upload a clear image of your item to attract buyers</p>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="image-upload-area">
                                        <input type="file" class="form-control d-none" name="image" id="imageInput" accept="image/*" required>
                                        <label for="imageInput" class="image-upload-label">
                                            <div class="upload-placeholder" id="uploadPlaceholder">
                                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                                <h5>Click to upload image</h5>
                                                <p class="text-muted">JPG, PNG or GIF (Max 5MB)</p>
                                            </div>
                                            <div id="imagePreviewContainer" style="display: none;">
                                                <img id="imagePreview" src="" alt="Preview" class="preview-image">
                                                <div class="image-actions">
                                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeImage()">
                                                        <i class="fas fa-trash"></i> Remove
                                                    </button>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 5: Review -->
                        <div class="step-content" data-step="5">
                            <div class="step-header">
                                <h4>Review Your Listing</h4>
                                <p class="text-muted">Please review all information before creating your listing</p>
                            </div>
                            
                            <div class="review-card">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="review-image">
                                            <img id="reviewImage" src="" alt="Product" class="img-fluid rounded">
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="review-details">
                                            <h5 id="reviewTitle">Product Title</h5>
                                            <div class="review-meta">
                                                <span class="badge bg-primary" id="reviewCategory">Category</span>
                                                <span class="badge bg-secondary" id="reviewProductType">Product Type</span>
                                                <span class="badge bg-info" id="reviewYear">Academic Year</span>
                                            </div>
                                            <p id="reviewDescription" class="mt-2 text-muted">Product description...</p>
                                            <div class="review-price">
                                                <h4 id="reviewPriceDisplay" class="text-success mb-0">0</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mt-4">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" name="is_fake_warning" id="fakeWarning" required>
                                    <label class="form-check-label" for="fakeWarning">
                                        <strong>I confirm that this product is genuine and the information provided is accurate</strong>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="modal-footer border-0">
                    <div class="step-navigation w-100">
                        <button type="button" class="btn btn-outline-secondary" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                            <i class="fas fa-arrow-left me-2"></i>Previous
                        </button>
                        <div class="flex-grow-1"></div>
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                            Next<i class="fas fa-arrow-right ms-2"></i>
                        </button>
                        <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;" form="createListingForm">
                            <i class="fas fa-plus-circle me-2"></i>Create Listing
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
        
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
    <script>
        // Function to show create listing modal
        function showCreateListing() {
            if (!currentUser) {
                showAlert('Please Login', 'You need to login to create a listing', 'warning');
                return;
            }
            const createListingModal = new bootstrap.Modal(document.getElementById('createListingModal'));
            createListingModal.show();
        }
        // Update the handlePathSelection function
        function handlePathSelection(path) {
            // Check if user is authenticated
            if (!currentUser) {
                showLoginModal();
                return;
            }
            
            // Handle different path selections
            if (path === 'buy') {
                // Redirect to buy.html page
                window.location.href = 'buy.html';
            } else if (path === 'sell') {
                // Show create listing modal
                showCreateListing();
            }
        }

        // Image preview handler
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for image preview
            const imageInput = document.querySelector('input[name="image"]');
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const preview = document.getElementById('imagePreview');
                            if (preview) {
                                preview.style.display = 'block';
                                preview.querySelector('img').src = e.target.result;
                            }
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Category change handler
            const categorySelect = document.getElementById('listingCategory');
            if (categorySelect) {
                categorySelect.addEventListener('change', function() {
                    const category = this.value;
                    const productTypeSelect = document.getElementById('productType');
                    
                    // Show/hide fields based on category
                    document.querySelector('.field-branch').style.display = category === 'books' ? 'block' : 'none';
                    document.querySelector('.field-subject').style.display = category === 'books' ? 'block' : 'none';
                    document.querySelector('.field-faculty').style.display = category === 'books' ? 'block' : 'none';
                    document.querySelector('.field-softcopy').style.display = category === 'books' ? 'block' : 'none';
                    
                    // Update product types
                    if (productTypeSelect) {
                        productTypeSelect.innerHTML = '<option value="">Select Product Type</option>';
                        
                        const productTypes = {
                            'electronic': ['Mobile', 'Laptop', 'Calculator'],
                            'books': ['Text books', 'Class book', 'Running notes'],
                            'clothes': ['Casual', 'Formal', 'Apron']
                        };
                        
                        if (productTypes[category]) {
                            productTypes[category].forEach(type => {
                                const option = document.createElement('option');
                                option.value = type.toLowerCase().replace(' ', '_');
                                option.textContent = type;
                                productTypeSelect.appendChild(option);
                            });
                        }
                    }
                    // Show/hide electronic-specific fields
                    document.querySelector('.field-working-condition').style.display = category === 'electronic' ? 'block' : 'none';
                    document.querySelector('.field-warranty').style.display = category === 'electronic' ? 'block' : 'none';
                });
            }
            // Form submission handler
            const createListingForm = document.getElementById('createListingForm');
            if (createListingForm) {
                createListingForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    try {
                        const submitBtn = this.querySelector('button[type="submit"]');
                        const originalBtnText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
                        
                        const formData = new FormData(this);
                        
                        // Set is_for_rent based on listing type
                        const listingType = document.getElementById('listingType').value;
                        formData.append('is_for_rent', listingType === 'rent' ? 'true' : 'false');
                        
                        // If it's a rental listing, ensure price is set to 0 or a minimal value
                        if (listingType === 'rent') {
                            formData.set('price', '0');
                        }
                        
                        const response = await fetch('/create-listing', {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            // Close modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('createListingModal'));
                            modal.hide();
                            
                            // Show success message
                            await Swal.fire({
                                title: 'Success!',
                                text: 'Your listing has been created successfully',
                                icon: 'success',
                                timer: 2000,
                                showConfirmButton: false
                            });
                            
                            // Reset form
                            this.reset();
                            const imagePreview = document.getElementById('imagePreview');
                            if (imagePreview) {
                                imagePreview.style.display = 'none';
                            }
                            
                            // Reload listings
                            loadListings();
                            
                        } else {
                            throw new Error(data.error || 'Failed to create listing');
                        }
                    } catch (error) {
                        console.error('Error creating listing:', error);
                        Swal.fire({
                            title: 'Error',
                            text: error.message,
                            icon: 'error'
                        });
                    } finally {
                        // Reset button state
                        const submitBtn = this.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Create Listing';
                        }
                    }
                });
            }
        });
        // Add these near your other global variables
        let currentOtherUserId = null;
        let currentListingId = null;
        let currentMessageThreadId = null;
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('openChat') === 'true') {
                // Add a small delay to ensure everything is initialized
                setTimeout(() => {
                    showChatModal();
                }, 500);
            }
        });
        // Mobile menu functionality (add to your existing JS)
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const chatSidebar = document.getElementById('chatSidebar');
        const chatWindow = document.getElementById('chatWindow');
        const sidebarBackdrop = document.getElementById('sidebarBackdrop');

        // Track mobile chat state
        let currentChatOpen = false;

        // UPDATED MOBILE CHAT FUNCTIONS
        // Show chat list (hide toggle, show sidebar)
        function showChatList() {
            console.log('showChatList called');
            if (isMobileView) {
                currentChatOpen = false;
                
                // Hide toggle button
                if (mobileMenuToggle) {
                    mobileMenuToggle.classList.add('hide-toggle');
                }
                
                // Show sidebar, hide chat window
                if (chatSidebar) {
                    chatSidebar.classList.remove('hide-mobile');
                    chatSidebar.classList.add('show-mobile');
                }
                
                // Hide backdrop
                if (sidebarBackdrop) {
                    sidebarBackdrop.classList.remove('show');
                }
                
                console.log('Chat list shown, toggle hidden');
            }
        }

        // Show chat window (show toggle, hide sidebar)
        function showChatWindow() {
            console.log('showChatWindow called');
            if (isMobileView) {
                currentChatOpen = true;
                
                // Show toggle button
                if (mobileMenuToggle) {
                    mobileMenuToggle.classList.remove('hide-toggle');
                }
                
                // Hide sidebar
                if (chatSidebar) {
                    chatSidebar.classList.add('hide-mobile');
                    chatSidebar.classList.remove('show-mobile');
                }
                
                // Hide backdrop
                if (sidebarBackdrop) {
                    sidebarBackdrop.classList.remove('show');
                }
                
                console.log('Chat window shown, toggle visible');
            }
        }

        // UPDATED Toggle mobile sidebar (only when in chat view)
        function toggleMobileSidebar() {
            console.log('toggleMobileSidebar called, currentChatOpen:', currentChatOpen);
            if (!isMobileView || !currentChatOpen) return;
            
            if (!chatSidebar || !sidebarBackdrop) {
                console.error('Required elements not found');
                return;
            }
            
            const isShowing = chatSidebar.classList.contains('show-mobile');
            console.log('Current state - isShowing:', isShowing);
            
            if (isShowing) {
                chatSidebar.classList.remove('show-mobile');
                chatSidebar.classList.add('hide-mobile');
                sidebarBackdrop.classList.remove('show');
                console.log('Hiding sidebar overlay');
            } else {
                chatSidebar.classList.remove('hide-mobile');
                chatSidebar.classList.add('show-mobile');
                sidebarBackdrop.classList.add('show');
                console.log('Showing sidebar overlay');
            }
        }

        // UPDATED Close mobile sidebar
        function closeMobileSidebar() {
            console.log('closeMobileSidebar called');
            if (isMobileView && currentChatOpen) {
                if (chatSidebar && sidebarBackdrop) {
                    chatSidebar.classList.add('hide-mobile');
                    chatSidebar.classList.remove('show-mobile');
                    sidebarBackdrop.classList.remove('show');
                    console.log('Sidebar overlay closed');
                }
            }
        }
        // Global variables
        let currentUser = null;
        let currentChatUser = null;
        let chatMessages = {};
        let currentPath = null;
        let isMobileView = window.innerWidth <= 768;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // UPDATED Add event listeners for mobile menu
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Mobile menu toggle clicked');
                    toggleMobileSidebar();
                });
            }
            
            if (sidebarBackdrop) {
                sidebarBackdrop.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Sidebar backdrop clicked');
                    closeMobileSidebar();
                });
            }

            checkAuthStatus();
            loadListings();
            initializeEventListeners();
            handleMobileResize();
            
            // Handle URL verification parameters
            const urlParams = new URLSearchParams(window.location.search);
            const verificationStatus = urlParams.get('verification');

            if (verificationStatus === 'success') {
                showAlert('Email Verified', 'You can now login!', 'success');
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (verificationStatus === 'invalid') {
                showAlert('Invalid Token', 'The verification link is invalid', 'error');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // UPDATED Handle mobile resize
        function handleMobileResize() {
            window.addEventListener('resize', function() {
                const wasMobile = isMobileView;
                isMobileView = window.innerWidth <= 768;
                
                if (wasMobile !== isMobileView) {
                    // Reset chat modal state when switching between mobile/desktop
                    if (document.getElementById('chatModal').classList.contains('show')) {
                        if (isMobileView) {
                            if (currentChatOpen) {
                                showChatWindow();
                            } else {
                                showChatList();
                            }
                        } else {
                            resetDesktopChatView();
                        }
                    }
                }
            });
        }

        // UPDATED resetDesktopChatView
        function resetDesktopChatView() {
            const sidebar = document.getElementById('chatSidebar');
            const window = document.getElementById('chatWindow');
            
            currentChatOpen = false;
            if (sidebar && window && mobileMenuToggle) {
                sidebar.classList.remove('show-mobile', 'hide-mobile', 'd-none');
                window.classList.remove('d-none');
                mobileMenuToggle.classList.add('hide-toggle');
            }
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Search and filter listeners
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');
            const sortFilter = document.getElementById('sortFilter');
            const collegeFilter = document.getElementById('collegeFilter');
            
            if (searchInput) {
                searchInput.addEventListener('input', debounce(loadListings, 500));
            }
            if (categoryFilter) {
                categoryFilter.addEventListener('change', loadListings);
            }
            if (sortFilter) {
                sortFilter.addEventListener('change', loadListings);
            }
            if (collegeFilter) {
                collegeFilter.addEventListener('change', loadListings);
            }

            // UPDATED Chat modal listeners
            const chatModal = document.getElementById('chatModal');
            if (chatModal) {
                chatModal.addEventListener('show.bs.modal', () => {
                    console.log('Chat modal showing');
                    isMobileView = window.innerWidth <= 768;
                    console.log('Modal opened, isMobileView:', isMobileView);
                    
                    // Always start with chat list on mobile
                    if (isMobileView) {
                        showChatList();
                    }
                    
                    initializeChat();
                });

                chatModal.addEventListener('hide.bs.modal', () => {
                    // Clean up chat when modal closes
                    currentChatUser = null;
                    currentChatOpen = false;
                    const chatContent = document.getElementById('chatContent');
                    const chatEmptyState = document.getElementById('chatEmptyState');
                    
                    if (chatContent) chatContent.style.display = 'none';
                    if (chatEmptyState) chatEmptyState.style.display = 'flex';
                    
                    // Clear refresh interval
                    if (window.chatRefreshInterval) {
                        clearInterval(window.chatRefreshInterval);
                    }
                    
                    closeMobileSidebar();
                });
            }

            // Message input listeners
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessage');
            
            if (messageInput && sendButton) {
                messageInput.addEventListener('input', function() {
                    const hasText = this.value.trim().length > 0;
                    sendButton.disabled = !hasText || !currentChatUser;
                });
                
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey && !sendButton.disabled) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                sendButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (!this.disabled) {
                        sendMessage();
                    }
                });
            }

            // Chat search listener
            const chatSearch = document.getElementById('chatSearch');
            if (chatSearch) {
                chatSearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const chatItems = document.querySelectorAll('.chat-item');
                    
                    chatItems.forEach(item => {
                        const userName = item.querySelector('h6')?.textContent?.toLowerCase() || '';
                        const lastMessage = item.querySelector('p')?.textContent?.toLowerCase() || '';
                        
                        if (userName.includes(searchTerm) || lastMessage.includes(searchTerm)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Utility function to debounce search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Check authentication status
        async function checkAuthStatus() {
            try {
                const response = await fetch('/check-session', {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        currentUser = data.user;
                        updateAuthUI();
                    }
                }
            } catch (error) {
                console.error('Failed to check auth status:', error);
            }
        }

        // Update authentication UI
        function updateAuthUI() {
            const authButtons = document.getElementById('authButtons');
            const userMenu = document.getElementById('userMenu');
            const userName = document.getElementById('userName');
            const notificationMenu = document.getElementById('notificationMenu');
            const currentUserName = document.getElementById('currentUserName');
            
            if (currentUser) {
                if (authButtons) authButtons.classList.add('d-none');
                if (userMenu) userMenu.classList.remove('d-none');
                if (notificationMenu) notificationMenu.classList.remove('d-none');
                if (userName) userName.textContent = currentUser.full_name || currentUser.email;
                if (currentUserName) currentUserName.textContent = currentUser.full_name || currentUser.email;
                
                if (currentUser.is_admin) {
                    const adminMenu = document.getElementById('adminMenu');
                    const reportsMenu = document.getElementById('reportsMenu');
                    if (adminMenu) adminMenu.classList.remove('d-none');
                    if (reportsMenu) reportsMenu.classList.remove('d-none');
                }
                
                if (currentUser.college) {
                    const collegeFilter = document.getElementById('collegeFilter');
                    if (collegeFilter) {
                        collegeFilter.value = currentUser.college;
                    }
                }
            } else {
                if (authButtons) authButtons.classList.remove('d-none');
                if (userMenu) userMenu.classList.add('d-none');
                if (notificationMenu) notificationMenu.classList.add('d-none');
            }
        }
        // Show loading state
        function showLoading() {
            const skeleton = document.getElementById('loadingSkeleton');
            const grid = document.getElementById('listingsGrid');
            
            if (skeleton) skeleton.style.display = 'flex';
            if (grid) grid.style.display = 'none';
            
            if (skeleton) {
                skeleton.innerHTML = Array(8).fill().map(() => `
                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="skeleton-card">
                            <div class="skeleton-image mb-3"></div>
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text medium"></div>
                            <div class="skeleton-text short"></div>
                        </div>
                    </div>
                `).join('');
            }
        }
        // Hide loading state
        function hideLoading() {
            const skeleton = document.getElementById('loadingSkeleton');
            const grid = document.getElementById('listingsGrid');
            
            if (skeleton) skeleton.style.display = 'none';
            if (grid) grid.style.display = 'flex';
        }
        // Load listings function
        // Load listings function - Updated with horizontal card layout
        async function loadListings() {
            showLoading();
            try {
                const searchInputEl = document.getElementById('searchInput');
                const categoryFilterEl = document.getElementById('categoryFilter');
                const sortFilterEl = document.getElementById('sortFilter');
                const query = searchInputEl ? encodeURIComponent(searchInputEl.value) : '';
                const category = categoryFilterEl ? encodeURIComponent(categoryFilterEl.value) : '';
                const college = currentUser ? encodeURIComponent(currentUser.college) : '';
                const sort = sortFilterEl ? sortFilterEl.value : 'newest';
                let sortBy = 'created_at';
                if (sort === 'price_low') sortBy = 'price_asc';
                if (sort === 'price_high') sortBy = 'price_desc';
                
                const response = await fetch(
                    `/listings?q=${query}&category=${category}&college=${college}&sort_by=${sortBy}`,
                    { credentials: 'same-origin' }
                );
                
                if (!response.ok) throw new Error(`HTTP ${response.status} - ${await response.text()}`);
                
                const { listings } = await response.json();
                const grid = document.getElementById('listingsGrid');
                
                if (!grid) {
                    throw new Error('Listings grid element not found');
                }
                
                grid.innerHTML = '';
                
                if (listings.length === 0) {
                    grid.innerHTML = `
                        <div class="col-12 text-center my-5">
                            <h4> Welcome to our wonderful marketplace!</h4>
                            <p class="text-muted">What an exciting moment - you're among the very first students from your college to discover us!</p>
                            <p><strong>Would you like the honor of creating the first listing from ${currentUser?.college || 'your college'}? We'd be thrilled to have you lead the way!</strong></p>
                            <div class="mt-3">
                                <button class="btn btn-primary me-2" onclick="handlePathSelection('sell')">
                                    <i class="fas fa-plus"></i> I'd love to create the first listing!
                                </button>
                            </div>
                        </div>`;
                    return;
                }

                listings.forEach(listing => {
                    console.debug("Processing listing:", listing.id, listing);
                    const isSoftCopy = Boolean(listing.is_softcopy);
                    const card = document.createElement('div');
                    // Changed to 3 cards per row: col-lg-4 instead of col-lg-3
                    card.className = 'col-12 col-sm-6 col-lg-4 mb-3';

                    // Image handling with fallback
                    const imageUrl = listing.image_url?.startsWith('http') 
                        ? listing.image_url 
                        : `/static/${listing.image_url || 'images/placeholder.jpg'}`;

                    // Create horizontal card layout - image left, details right
                    card.innerHTML = `
                        <div class="listing-card-horizontal-clean">
                            <div class="row g-0 h-100">
                                <!-- Left side - Image -->
                                <div class="col-4">
                                    <div class="listing-image-section">
                                        <img src="${imageUrl}" 
                                            class="listing-image-pro" 
                                            alt="${listing.title || 'Listing'}"
                                            loading="lazy">
                                        
                                        <div class="listing-badges-overlay">
                                            <span class="badge-category">${listing.category || 'Other'}</span>
                                            ${listing.is_for_rent ? '<span class="badge-rental">Rent</span>' : ''}
                                            ${listing.is_softcopy ? '<span class="badge-digital">Digital</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right side - Details -->
                                <div class="col-8">
                                    <div class="listing-content-section">
                                        <div class="content-top">
                                            <h3 class="listing-title-pro">${listing.title || 'Untitled'}</h3>
                                            
                                            <div class="listing-details">
                                                <div class="detail-row">
                                                    <i class="fas fa-user-circle"></i>
                                                    <span class="detail-text">${listing.seller?.name || 'Unknown Seller'}</span>
                                                </div>
                                                <div class="detail-row">
                                                    <i class="fas fa-university"></i>
                                                    <span class="detail-text">${listing.seller?.college || 'College not specified'}</span>
                                                </div>
                                                ${listing.faculty_name ? `
                                                <div class="detail-row">
                                                    <i class="fas fa-chalkboard-teacher"></i>
                                                    <span class="detail-text">${listing.faculty_name}</span>
                                                </div>` : ''}
                                            </div>
                                        </div>
                                        
                                        <div class="content-bottom">
                                            <div class="listing-price-section">
                                                <div class="price-display">
                                                    ${listing.is_for_rent ?
                                                    `${listing.rent_price || 0}<span class="price-period">/day</span>` :
                                                    listing.is_softcopy ? 
                                                        `<span class="price-original">${listing.price || 0}</span> <span class="price-free">Free</span>` :
                                                        `${listing.price || 0}`}
                                                </div>
                                            </div>
                                            
                                            <div class="listing-actions-section">
                                                ${listing.is_softcopy ?
                                                    `<button class="btn-primary-action" 
                                                            onclick="handleDownload(${listing.id}, '${listing.title}', event)">
                                                        <i class="fas fa-download"></i>
                                                        Download
                                                    </button>` :
                                                    `<button class="btn-primary-action" 
                                                            onclick="contactSeller(${listing.id})">
                                                        <i class="fas fa-envelope"></i>
                                                        Contact
                                                    </button>`
                                                }
                                                
                                                <button class="btn-secondary-action" 
                                                        onclick="addToWishlist(${listing.id})"
                                                        title="Add to Wishlist">
                                                    <i class="fas fa-heart"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Listing load error:', error);
                const grid = document.getElementById('listingsGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div class="col-12 text-center my-5">
                            <div class="alert alert-danger">
                                <h5>Error Loading Listings</h5>
                                <p>${error.message}</p>
                                <button class="btn btn-primary" onclick="loadListings()">Try Again</button>
                            </div>
                        </div>`;
                }
                showAlert('Error', `Failed to load listings: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }
                // Contact seller functionality
        async function contactSeller(listingId) {
            if (!currentUser) {
                showAlert('Please Login', 'You need to login to contact sellers', 'warning');
                return;
            }          
            try {
                // FIXED: Fetch specific listing by ID
                const response = await fetch(`/listings/${listingId}`, {
                    credentials: 'same-origin'
                });               
                if (!response.ok) {
                    throw new Error('Failed to fetch listing details');
                }               
                const listing = await response.json();               
                // Verify we got the correct listing
                if (listing.id !== listingId) {
                    throw new Error('Listing mismatch - please try again');
                }               
                // Set the correct global variables
                currentOtherUserId = listing.seller.id;
                currentListingId = listingId;
                currentMessageThreadId = `contact_${Date.now()}`;               
                const { value: message } = await Swal.fire({
                    title: 'Send Message to Seller',
                    input: 'textarea',
                    inputLabel: 'Your message',
                    inputPlaceholder: 'Type your message here...',
                    inputAttributes: {
                        'aria-label': 'Type your message here'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Send Message',
                    showLoaderOnConfirm: true,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'You need to write something!'
                        }
                    },
                    preConfirm: (message) => {
                        return fetch('/api/messages/send', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                receiver_id: listing.seller.id,
                                listing_id: listingId,
                                content: message
                            }),
                            credentials: 'same-origin'
                        })
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to send message');
                            return response.json();
                        })
                        .catch(error => {
                            Swal.showValidationMessage(`Request failed: ${error.message}`);
                        });
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });               
                if (message) {
                    Swal.fire({
                        title: 'Message Sent!',
                        text: 'Your message has been sent to the seller.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    setTimeout(() => {
                        showChatModal();
                    }, 2000);
                }
            } catch (error) {
                console.error('Error contacting seller:', error);
                showAlert('Error', error.message, 'error');
            }
        }
        // Add to wishlist functionality
        async function addToWishlist(listingId) {
            if (!currentUser) {
                showAlert('Please Login', 'You need to login to add items to wishlist', 'warning');
                return;
            }           
            try {
                const wishlistButton = event.target.closest('button');
                if (wishlistButton) {
                    const originalText = wishlistButton.innerHTML;
                    wishlistButton.disabled = true;
                    wishlistButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
                }               
                const response = await fetch('/api/wishlist/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ listing_id: listingId }),
                    credentials: 'same-origin'
                });               
                const data = await response.json();               
                if (!response.ok) throw new Error(data.error || 'Failed to add to wishlist');               
                Swal.fire({
                    title: 'Added to Wishlist!',
                    text: data.message || 'Item has been added to your wishlist',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });               
                if (wishlistButton) {
                    wishlistButton.innerHTML = '<i class="fas fa-heart me-2"></i>Added to Wishlist';
                    wishlistButton.classList.remove('btn-outline-primary');
                    wishlistButton.classList.add('btn-success');
                    setTimeout(() => {
                        wishlistButton.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Wishlist error:', error);
                showAlert('Error', error.message, 'error');  
                if (wishlistButton) {
                    wishlistButton.disabled = false;
                    wishlistButton.innerHTML = '<i class="fas fa-heart me-2"></i>Add to Wishlist';
                }
            }
        }
        // Handle PDF downloads
        function handleDownload(listingId, title, event) {
            event.preventDefault();
            const link = document.createElement('a');
            link.href = `/download/${listingId}`;
            link.download = `${title}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            return false;
        }
        // Show chat modal
        function showChatModal() {
            if (!currentUser) {
                Swal.fire({
                    title: 'Login Required',
                    text: 'You need to login to use the chat feature',
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'Login',
                    cancelButtonText: 'Register',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        showLoginModal();
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        showRegisterModal();
                    }
                });
                return;
            }          
            const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
            chatModal.show();
        }
        // Initialize chat
        function initializeChat() {
            console.log('Initializing chat...');          
            // Reset to empty state
            const chatContent = document.getElementById('chatContent');
            const chatEmptyState = document.getElementById('chatEmptyState');          
            if (chatContent) chatContent.style.display = 'none';
            if (chatEmptyState) chatEmptyState.style.display = 'flex';          
            // Reset current chat user
            currentChatUser = null;          
            // Disable message input
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessage');
            if (messageInput) messageInput.disabled = true;
            if (sendButton) sendButton.disabled = true;          
            // Load conversations
            loadChats();          
            // Set up refresh interval
            if (window.chatRefreshInterval) {
                clearInterval(window.chatRefreshInterval);
            }           
            window.chatRefreshInterval = setInterval(() => {
                if (currentChatUser) {
                    loadChatMessages(currentChatUser.id, currentChatUser.listing_id);
                } else {
                    loadChats();
                }
            }, 10000);
        }
        // Load chats
        async function loadChats() {
            try {
                const response = await fetch('/api/messages', {
                    credentials: 'same-origin'
                });               
                if (!response.ok) throw new Error('Failed to load chats');                
                const data = await response.json();
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = '';
                if (data.messages && data.messages.length > 0) {
                    const conversations = groupMessagesByConversation(data.messages);                    
                    conversations.forEach(conv => {
                        const lastMessage = conv.messages[conv.messages.length - 1];
                        const otherUser = lastMessage.sender_id === currentUser.id ? 
                            lastMessage.receiver : lastMessage.sender;

                        const chatItem = createChatListItem(otherUser, lastMessage);
                        chatList.appendChild(chatItem);
                    });
                } else {
                    chatList.innerHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-comments fa-3x mb-3 opacity-50"></i>
                            <h6>No conversations yet</h6>
                            <p class="small mb-0">Start by contacting a seller!</p>
                            <small class="text-muted">Messages will appear here</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading chats:', error);
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3 text-warning"></i>
                        <h6>Error loading conversations</h6>
                        <p class="small text-danger mb-2">${error.message}</p>
                        <button class="btn btn-sm btn-primary" onclick="loadChats()">
                            <i class="fas fa-redo me-1"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }
        // Group messages by conversation
        function groupMessagesByConversation(messages) {
            const conversations = {};           
            messages.forEach(message => {
                const conversationId = [message.sender_id, message.receiver_id].sort().join('-');               
                if (!conversations[conversationId]) {
                    conversations[conversationId] = {
                        messages: [],
                        otherUserId: message.sender_id === currentUser.id ? 
                            message.receiver_id : message.sender_id
                    };
                }
                conversations[conversationId].messages.push(message);
            });
            // Sort messages in each conversation by date
            Object.values(conversations).forEach(conv => {
                conv.messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            });
            return Object.values(conversations);
        }
        // Create chat list item
        function createChatListItem(user, lastMessage, unreadCount = 0) {
            const div = document.createElement('div');
            div.className = `chat-item ${unreadCount > 0 ? 'unread' : ''}`;
            div.setAttribute('data-user-id', user.id);          
            const listingId = lastMessage.listing_id || 1;          
            div.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="user-avatar me-3 position-relative">
                        <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                            style="width: 45px; height: 45px; color: white; font-weight: bold;">
                            ${(user.full_name || user.name || 'U')[0].toUpperCase()}
                        </div>
                        <span class="position-absolute bottom-0 end-0 bg-success border border-white rounded-circle" 
                            style="width: 12px; height: 12px;"></span>
                    </div>
                    <div class="flex-grow-1" style="min-width: 0;">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <h6 class="mb-0 text-truncate fw-bold">${user.full_name || user.name || 'Unknown User'}</h6>
                            <small class="text-muted ms-2">${formatMessageTime(lastMessage.created_at)}</small>
                        </div>
                        <p class="mb-0 text-muted small text-truncate">${lastMessage.content}</p>
                    </div>
                    ${unreadCount > 0 ? `<span class="badge bg-danger rounded-pill ms-2">${unreadCount}</span>` : ''}
                </div>
            `;
            div.addEventListener('click', function() {
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });

                this.classList.add('active');
                openChat(user, listingId);
            });
            return div;
        }
        // UPDATED Open chat
        async function openChat(user, listingId) {
            currentChatUser = {
                id: user.id,
                listing_id: listingId,
                full_name: user.full_name || user.name
            };
            
            // ADD THESE LINES:
            currentOtherUserId = user.id;
            currentListingId = listingId;
            
            console.log('Opening chat with:', currentChatUser);
            
            // Show chat content, hide empty state
            const chatContent = document.getElementById('chatContent');
            const chatEmptyState = document.getElementById('chatEmptyState');
            if (chatEmptyState) chatEmptyState.style.display = 'none';
            if (chatContent) {
                chatContent.style.display = 'flex';
                chatContent.style.flexDirection = 'column';
            }
            
            // Update chat header
            const contactName = document.getElementById('chatContactName');
            const contactAvatar = document.getElementById('chatContactAvatar');
            const userName = user.full_name || user.name || 'Unknown User';
            const userInitial = userName[0].toUpperCase();
            if (contactName) contactName.textContent = userName;
            if (contactAvatar) contactAvatar.textContent = userInitial;
            
            // Enable message input
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessage');
            if (messageInput) {
                messageInput.disabled = false;
                messageInput.placeholder = `Type a message to ${userName}...`;
                messageInput.value = '';
                setTimeout(() => messageInput.focus(), 100);
            }
            if (sendButton) {
                sendButton.disabled = true; // Will be enabled when user types
            }
            
            // NEW: Check if current user is the seller and show/hide "Mark as Sold" button
            try {
                const response = await fetch(`/listings/${listingId}`);
                const listingData = await response.json();
                
                const soldBtn = document.getElementById('markSoldBtn');
                if (soldBtn && listingData.seller && listingData.seller.id === currentUser.id) {
                    // Current user is the seller, show the button
                    soldBtn.style.display = 'inline-flex';
                } else if (soldBtn) {
                    // Current user is NOT the seller, hide the button
                    soldBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking seller:', error);
                // On error, hide the button to be safe
                const soldBtn = document.getElementById('markSoldBtn');
                if (soldBtn) soldBtn.style.display = 'none';
            }
            
            // UPDATED Show mobile chat window
            if (isMobileView) {
                showChatWindow();
            }
            
            // Load messages
            loadChatMessages(user.id, listingId);
        }
        // Load chat messages
        async function loadChatMessages(userId, listingId) {
            try {
                const response = await fetch(`/api/messages?other_user_id=${userId}&listing_id=${listingId}`, {
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    throw new Error('Failed to load messages');
                }
                const data = await response.json();
                const uniqueMessages = Array.from(
                    new Map(data.messages.map(item => [item.id, item])).values()
                ).sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                
                displayMessages(uniqueMessages);  
            } catch (error) {
                console.error('Error loading messages:', error);
                const messageContainer = document.querySelector('.message-container');
                if (messageContainer) {
                    messageContainer.innerHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3 text-warning"></i>
                            <h6>Error loading messages</h6>
                            <p class="small text-danger mb-2">${error.message}</p>
                            <button class="btn btn-sm btn-primary" onclick="loadChatMessages(${userId}, ${listingId})">
                                <i class="fas fa-redo me-1"></i> Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }
        // Display messages
        function displayMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            const messageContainer = document.querySelector('.message-container');
            
             if (messages.length > 0) {
                currentMessageThreadId = messages[0].thread_id || `temp_${Date.now()}`;
            }
            if (!messageContainer) {
                console.error('Message container not found');
                return;
            }
            messageContainer.innerHTML = '';
            if (messages.length === 0) {
                messageContainer.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-comments fa-3x mb-3 opacity-50"></i>
                        <h6>No messages yet</h6>
                        <p class="small mb-0">Start the conversation!</p>
                        <small class="text-muted">Your messages will appear here</small>
                    </div>
                `;
                return;
            }
            messages.forEach(message => {
                const messageElement = createMessageElement(message);
                messageContainer.appendChild(messageElement);
            });
            // Scroll to bottom
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }
        // Create message element
        function createMessageElement(message) {
            const isSent = parseInt(message.sender_id) === parseInt(currentUser.id);
            const div = document.createElement('div');
            div.className = `message ${isSent ? 'sent' : 'received'}`;
            div.innerHTML = `
                <div class="message-content">${escapeHtml(message.content)}</div>
                <div class="message-time">
                    ${formatMessageTime(message.created_at)}
                    ${isSent ? `<i class="fas fa-check${message.read ? '-double text-info' : ''} ms-1"></i>` : ''}
                </div>
            `;
            return div;
        }
        // Send message
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            if (!content || !currentChatUser) {
                return;
            }
            const sendButton = document.getElementById('sendMessage');
            // Disable UI while sending
            messageInput.disabled = true;
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const response = await fetch('/api/messages/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        receiver_id: currentChatUser.id,
                        listing_id: currentChatUser.listing_id,
                        content: content
                    }),
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to send message');
                }
                // Clear input and reload messages
                messageInput.value = '';
                await loadChatMessages(currentChatUser.id, currentChatUser.listing_id);
                // Send notification
                sendMessageNotification(currentChatUser.id, currentChatUser.listing_id, currentUser.id);
            } catch (error) {
                console.error('Send message error:', error);
                showAlert('Error', error.message, 'error');
            } finally {
                // Re-enable UI
                messageInput.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendButton.disabled = true; // Will be enabled when user types again
                messageInput.focus();
            }
        }
        // Send message notification
        async function sendMessageNotification(recipientId, listingId, senderId) {
            try {
                const response = await fetch('/api/send_message_notification', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        recipient_id: recipientId,
                        listing_id: listingId,
                        sender_id: senderId
                    }),
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    console.warn('Failed to send notification');
                }
            } catch (error) {
                console.warn('Notification failed:', error);
            }
        }
        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (now - date < 7 * 24 * 60 * 60 * 1000) {
                return date.toLocaleDateString([], { weekday: 'short', hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }
        function showAlert(title, message, type = 'info') {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: title,
                    text: message,
                    icon: type,
                    timer: type === 'success' ? 2000 : undefined,
                    showConfirmButton: type !== 'success'
                });
            } else {
                alert(`${title}: ${message}`);
            }
        }
        // My Listings function
        async function showMyListings() {
            if (!currentUser) {
                showAlert('Please Login', 'You need to login to view your listings', 'warning');
                return;
            }
            // Open the dedicated my-listings page
            window.open('/my-listings.html', '_blank');
        }
        // Updated Wishlist function  
        async function showWishlist() {
            if (!currentUser) {
                showAlert('Please Login', 'You need to login to view your wishlist', 'warning');
                return;
            }
            // Open the dedicated my-wishlist page
            window.open('/my-wishlist.html', '_blank');
        }
        // Updated Logout function
        async function logout() {
            try {
                await fetch('/logout', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                // Clear all admin-related localStorage items
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('adminDashboardOpen');
                currentUser = null;
                updateAuthUI();
                // Show success message
                Swal.fire({
                    title: 'Success',
                    text: 'Logged out successfully',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                // Reset any path-specific UI elements
                const heroSection = document.querySelector('.hero-section');
                const listingsSection = document.getElementById('listingsSection');
                // Show hero section (home page) and hide listings section if they exist
                if (heroSection) heroSection.style.display = 'flex';
                if (listingsSection) listingsSection.style.display = 'none';
                // Reset current path
                currentPath = null;
                // Clear chat refresh interval
                if (window.chatRefreshInterval) {
                    clearInterval(window.chatRefreshInterval);
                }
                // Optionally, redirect to the root URL after a short delay
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            } catch (error) {
                console.error('Logout error:', error);
                showAlert('Error', 'Failed to logout', 'error');
            }
        }
        // Placeholder functions for missing functionality
        function showLoginModal() {
    // Navigate to index.html with a parameter to show login modal
            window.location.href = 'index.html?modal=login';
        }
        function showRegisterModal() {
            // Navigate to index.html with a parameter to show register modal
            window.location.href = 'index.html?modal=register';
        }
        function showReportModal() {
            console.log("Opening report modal");
            // Get current conversation info
            const otherUserId = currentOtherUserId;
            const listingId = currentListingId; 
            console.log("Report modal: listing ID =", listingId, "thread ID =", currentMessageThreadId);
            // If we don't have a message thread ID, create a temporary one
            if (!currentMessageThreadId) {
                currentMessageThreadId = `temp_${Date.now()}`;
                console.log("Created temporary message thread ID:", currentMessageThreadId);
            }
            // Update hidden fields
            document.getElementById('reportListingId').value = listingId || '';
            document.getElementById('reportMessageThreadId').value = currentMessageThreadId;
            // Show modal using Bootstrap
            const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
            reportModal.show();
        }
        function closeReportModal() {
            const reportModal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
            if (reportModal) {
                reportModal.hide();
            }
        }
        function openReportModal() {
            console.log("Opening report modal");
            if (!currentListingId || !currentMessageThreadId) {
                console.error("Missing listing ID or message thread ID for report");
                // Try to get from URL if available
                const urlParams = new URLSearchParams(window.location.search);
                const listingId = urlParams.get('listing');
                if (listingId) {
                    currentListingId = listingId;
                } else {
                    showAlert('Error', 'Cannot report at this time. Please try again later.', 'error');
                    return;
                }
            }
            // Set values in the hidden fields
            document.getElementById('reportListingId').value = currentListingId;
            document.getElementById('reportMessageThreadId').value = currentMessageThreadId || '';
            const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
            reportModal.show();
        }
        document.getElementById('reportForm').addEventListener('submit', async (e) => {e.preventDefault();
            const formData = new FormData();
            const listingId = document.getElementById('reportListingId').value;
            const messageThreadId = document.getElementById('reportMessageThreadId').value;
            const description = document.getElementById('reportDescription').value;
            if (!description) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please describe the issue you\'re reporting.'
                });
                return;
            }
            // Always ensure we have a message thread ID (even if temporary)
            if (!messageThreadId) {
                const tempId = `temp_${Date.now()}`;
                console.log("Created temporary ID for form submission:", tempId);
                formData.append('message_thread_id', tempId);
            } else {
                formData.append('message_thread_id', messageThreadId);
            }
            // Add listing ID if available
            if (listingId) {
                formData.append('listing_id', listingId);
            }
            formData.append('description', description);
            const reportImage = document.getElementById('reportImage').files[0];
            if (reportImage) {
                formData.append('image', reportImage);
            }
            try {
                // Show loading state
                Swal.fire({
                    title: 'Submitting report...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                const response = await fetch('/api/report/create', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Report Submitted',
                        text: 'Thank you for your report. We will review it shortly.'
                    });
                    closeReportModal();
                    // Clear the form
                    document.getElementById('reportDescription').value = '';
                    document.getElementById('reportImage').value = '';
                    document.getElementById('reportPreviewImage').classList.add('d-none');
                } else {
                    throw new Error(data.error || 'Failed to submit report');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message
                });
            }
        });
        // Preview report image
        document.getElementById('reportImage').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const preview = document.getElementById('reportPreviewImage');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('d-none');
            }
        });
        let currentStep = 1;
        const totalSteps = 5;
        function initializeStepForm() {
            // Reset form to step 1
            currentStep = 1;
            updateStepDisplay();
            updateProgressBar();
            updateButtons();
            // Reset form data
            document.getElementById('createListingForm').reset();
            clearImagePreview();
            // Hide conditional fields
            document.querySelectorAll('.field-branch, .field-faculty, .field-subject, .field-softcopy, .field-fileupload, .field-working-condition, .field-warranty').forEach(field => {
                field.style.display = 'none';
            });
        }
        function changeStep(direction) {
            const newStep = currentStep + direction;
            // Validate current step before proceeding
            if (direction > 0 && !validateStep(currentStep)) {
                return;
            }
            if (newStep >= 1 && newStep <= totalSteps) {
                currentStep = newStep;
                updateStepDisplay();
                updateProgressBar();
                updateButtons();
                // Update review section if we're on the last step
                if (currentStep === 5) {
                    updateReviewSection();
                }
            }
        }
        function updateStepDisplay() {
            // Hide all step contents
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            // Show current step content
            const currentContent = document.querySelector(`.step-content[data-step="${currentStep}"]`);
            if (currentContent) {
                currentContent.classList.add('active');
            }
            // Update step indicators
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                
                if (index + 1 === currentStep) {
                    indicator.classList.add('active');
                } else if (index + 1 < currentStep) {
                    indicator.classList.add('completed');
                }
            });
        }
        function updateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            const progressPercentage = (currentStep / totalSteps) * 100;
            progressBar.style.width = progressPercentage + '%';
        }
        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            // Show/hide previous button
            prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
            // Show next or submit button
            if (currentStep < totalSteps) {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            }
        }
        function validateStep(step) {
            switch (step) {
                case 1:
                    const category = document.getElementById('listingCategory').value;
                    const productType = document.getElementById('productType').value;
                    const academicYear = document.getElementById('academicYear').value;
                    
                    if (!category) {
                        showAlert('Required Field', 'Please select a category', 'warning');
                        return false;
                    }
                    if (!productType) {
                        showAlert('Required Field', 'Please select a product type', 'warning');
                        return false;
                    }
                    if (!academicYear) {
                        showAlert('Required Field', 'Please select an academic year', 'warning');
                        return false;
                    }
                    return true;
                    
                case 2:
                    const title = document.querySelector('input[name="title"]').value.trim();
                    const description = document.querySelector('textarea[name="description"]').value.trim();
                    
                    if (!title) {
                        showAlert('Required Field', 'Please enter a title for your listing', 'warning');
                        return false;
                    }
                    if (title.length < 10) {
                        showAlert('Title Too Short', 'Please enter at least 10 characters for the title', 'warning');
                        return false;
                    }
                    if (!description) {
                        showAlert('Required Field', 'Please enter a description', 'warning');
                        return false;
                    }
                    if (description.length < 20) {
                        showAlert('Description Too Short', 'Please enter at least 20 characters for the description', 'warning');
                        return false;
                    }
                    return true;
                    
                case 3:
                    const listingType = document.querySelector('input[name="listing_type"]:checked').value;
                    
                    if (listingType === 'sell') {
                        const price = document.querySelector('input[name="price"]').value;
                        if (!price || price <= 0) {
                            showAlert('Invalid Price', 'Please enter a valid selling price', 'warning');
                            return false;
                        }
                    } else {
                        const rentPrice = document.querySelector('input[name="rent_price"]').value;
                        const rentTenure = document.querySelector('input[name="rent_tenure"]').value;
                        
                        if (!rentPrice || rentPrice <= 0) {
                            showAlert('Invalid Price', 'Please enter a valid rental price', 'warning');
                            return false;
                        }
                        if (!rentTenure || rentTenure <= 0) {
                            showAlert('Invalid Tenure', 'Please enter a valid rental period', 'warning');
                            return false;
                        }
                    }
                    return true;
                    
                case 4:
                    const imageInput = document.getElementById('imageInput');
                    if (!imageInput.files || imageInput.files.length === 0) {
                        showAlert('Image Required', 'Please upload an image of your product', 'warning');
                        return false;
                    }
                    
                    const file = imageInput.files[0];
                    if (file.size > 5 * 1024 * 1024) {
                        showAlert('File Too Large', 'Please upload an image smaller than 5MB', 'warning');
                        return false;
                    }
                    return true;
                    
                case 5:
                    const fakeWarning = document.getElementById('fakeWarning').checked;
                    if (!fakeWarning) {
                        showAlert('Confirmation Required', 'Please confirm that your product information is accurate', 'warning');
                        return false;
                    }
                    return true;
                    
                default:
                    return true;
            }
        }

        function updateReviewSection() {
            const form = document.getElementById('createListingForm');
            const formData = new FormData(form);
            
            // Update review image
            const imageInput = document.getElementById('imageInput');
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('reviewImage').src = e.target.result;
                };
                reader.readAsDataURL(imageInput.files[0]);
            }
            
            // Update review details
            document.getElementById('reviewTitle').textContent = formData.get('title') || 'Product Title';
            document.getElementById('reviewDescription').textContent = formData.get('description') || 'Product description...';
            
            // Update badges
            const category = formData.get('category');
            const productType = formData.get('product_type');
            const academicYear = formData.get('study_year');
            
            document.getElementById('reviewCategory').textContent = category ? category.charAt(0).toUpperCase() + category.slice(1) : 'Category';
            document.getElementById('reviewProductType').textContent = productType ? productType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Product Type';
            document.getElementById('reviewYear').textContent = academicYear ? `${academicYear}${getOrdinalSuffix(academicYear)} Year` : 'Academic Year';
            
            // Update price display
            const listingType = document.querySelector('input[name="listing_type"]:checked').value;
            let priceText = '0';
            
            if (listingType === 'sell') {
                const price = formData.get('price');
                priceText = price ? `${price}` : '0';
            } else {
                const rentPrice = formData.get('rent_price');
                priceText = rentPrice ? `${rentPrice}/day` : '0/day';
            }
            
            document.getElementById('reviewPriceDisplay').textContent = priceText;
        }

        function getOrdinalSuffix(num) {
            const j = num % 10;
            const k = num % 100;
            if (j == 1 && k != 11) return "st";
            if (j == 2 && k != 12) return "nd";
            if (j == 3 && k != 13) return "rd";
            return "th";
        }

        function removeImage() {
            const imageInput = document.getElementById('imageInput');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            
            imageInput.value = '';
            uploadPlaceholder.style.display = 'block';
            imagePreviewContainer.style.display = 'none';
        }

        function clearImagePreview() {
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            
            if (uploadPlaceholder) uploadPlaceholder.style.display = 'block';
            if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
        }

        // REPLACE your existing DOMContentLoaded event listener with this enhanced version
        document.addEventListener('DOMContentLoaded', function() {
            // ... your existing DOMContentLoaded code ...
            
            // Initialize step form when modal is shown
            const createListingModal = document.getElementById('createListingModal');
            if (createListingModal) {
                createListingModal.addEventListener('show.bs.modal', function() {
                    initializeStepForm();
                });
            }
            
            // Enhanced Image upload handler
            const imageInput = document.getElementById('imageInput');
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file size
                        if (file.size > 5 * 1024 * 1024) {
                            showAlert('File Too Large', 'Please select an image smaller than 5MB', 'error');
                            this.value = '';
                            return;
                        }
                        
                        // Validate file type
                        if (!file.type.match('image.*')) {
                            showAlert('Invalid File Type', 'Please select a valid image file', 'error');
                            this.value = '';
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
                            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                            const imagePreview = document.getElementById('imagePreview');
                            
                            if (uploadPlaceholder && imagePreviewContainer && imagePreview) {
                                uploadPlaceholder.style.display = 'none';
                                imagePreviewContainer.style.display = 'block';
                                imagePreview.src = e.target.result;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Enhanced Category change handler
            const categorySelect = document.getElementById('listingCategory');
            if (categorySelect) {
                categorySelect.addEventListener('change', function() {
                    const category = this.value;
                    const productTypeSelect = document.getElementById('productType');
                    
                    // Reset product type
                    if (productTypeSelect) {
                        productTypeSelect.innerHTML = '<option value="">Select Product Type</option>';
                    }
                    
                    // Show/hide conditional fields based on category
                    const branchField = document.querySelector('.field-branch');
                    const subjectField = document.querySelector('.field-subject');
                    const facultyField = document.querySelector('.field-faculty');
                    const softcopyField = document.querySelector('.field-softcopy');
                    const fileuploadField = document.querySelector('.field-fileupload');
                    const workingConditionField = document.querySelector('.field-working-condition');
                    const warrantyField = document.querySelector('.field-warranty');
                    
                    // Hide all conditional fields first
                    [branchField, subjectField, facultyField, softcopyField, fileuploadField, workingConditionField, warrantyField].forEach(field => {
                        if (field) field.style.display = 'none';
                    });
                    
                    // Show fields based on category
                    if (category === 'books') {
                        if (branchField) branchField.style.display = 'block';
                        if (subjectField) subjectField.style.display = 'block';
                        if (facultyField) facultyField.style.display = 'block';
                        if (softcopyField) softcopyField.style.display = 'block';
                    } else if (category === 'electronic') {
                        if (workingConditionField) workingConditionField.style.display = 'block';
                        if (warrantyField) warrantyField.style.display = 'block';
                    }
                    
                    // Update product types based on category
                    const productTypes = {
                        'electronic': [
                            { value: 'mobile', text: ' Mobile' },
                            { value: 'laptop', text: ' Laptop' },
                            { value: 'calculator', text: ' Calculator' },
                            { value: 'tablet', text: ' Tablet' },
                            { value: 'headphones', text: ' Headphones' }
                        ],
                        'books': [
                            { value: 'text_books', text: ' Text Books' },
                            { value: 'class_book', text: ' Class Book' },
                            { value: 'running_notes', text: ' Running Notes' },
                            { value: 'reference_books', text: ' Reference Books' }
                        ],
                        'clothes': [
                            { value: 'casual', text: ' Casual' },
                            { value: 'formal', text: ' Formal' },
                            { value: 'apron', text: ' Apron' },
                            { value: 'uniform', text: ' Uniform' }
                        ]
                    };
                    
                    if (productTypes[category] && productTypeSelect) {
                        productTypes[category].forEach(type => {
                            const option = document.createElement('option');
                            option.value = type.value;
                            option.textContent = type.text;
                            productTypeSelect.appendChild(option);
                        });
                    }
                });
            }
            
            // Enhanced listing type handler
            const sellType = document.getElementById('sellType');
            const rentType = document.getElementById('rentType');
            
            if (sellType && rentType) {
                [sellType, rentType].forEach(radio => {
                    radio.addEventListener('change', function() {
                        toggleRentFields();
                    });
                });
            }
            
            // Copy type handler for books
            const softCopy = document.getElementById('softCopy');
            const hardCopy = document.getElementById('hardCopy');
            
            if (softCopy && hardCopy) {
                [softCopy, hardCopy].forEach(radio => {
                    radio.addEventListener('change', function() {
                        toggleFileUpload();
                    });
                });
            }
            
            // Enhanced form submission handler
            const createListingForm = document.getElementById('createListingForm');
            if (createListingForm) {
                createListingForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Final validation before submission
                    if (!validateStep(5)) {
                        return;
                    }
                    
                    try {
                        const submitBtn = document.getElementById('submitBtn');
                        const originalBtnText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Listing...';
                        
                        const formData = new FormData(this);
                        
                        // Set is_for_rent based on listing type
                        const listingType = document.querySelector('input[name="listing_type"]:checked').value;
                        formData.append('is_for_rent', listingType === 'rent' ? 'true' : 'false');
                        
                        // If it's a rental listing, ensure price is set to 0
                        if (listingType === 'rent') {
                            formData.set('price', '0');
                        }
                        
                        const response = await fetch('/create-listing', {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            // Close modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('createListingModal'));
                            modal.hide();
                            
                            // Show success message with confetti effect
                            await Swal.fire({
                                title: 'Listing Created Successfully! ',
                                text: 'Your listing is now live and visible to other students',
                                icon: 'success',
                                timer: 3000,
                                showConfirmButton: false,
                                backdrop: true,
                                allowOutsideClick: false
                            });
                            
                            // Reset form
                            this.reset();
                            initializeStepForm();
                            
                            // Reload listings
                            loadListings();
                            
                        } else {
                            throw new Error(data.error || 'Failed to create listing');
                        }
                    } catch (error) {
                        console.error('Error creating listing:', error);
                        Swal.fire({
                            title: 'Error Creating Listing',
                            text: error.message,
                            icon: 'error',
                            confirmButtonText: 'Try Again'
                        });
                    } finally {
                        // Reset button state
                        const submitBtn = document.getElementById('submitBtn');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Create Listing';
                        }
                    }
                });
            }
        });

        // Enhanced toggle functions
        function toggleRentFields() {
            const listingType = document.querySelector('input[name="listing_type"]:checked')?.value;
            const rentFields = document.querySelectorAll('.rent-field');
            const sellPriceField = document.getElementById('sellPriceField');
            
            if (listingType === 'rent') {
                rentFields.forEach(field => field.style.display = 'block');
                if (sellPriceField) sellPriceField.style.display = 'none';
                
                // Update required fields
                const rentPriceInput = document.querySelector('input[name="rent_price"]');
                const rentTenureInput = document.querySelector('input[name="rent_tenure"]');
                const priceInput = document.querySelector('input[name="price"]');
                
                if (rentPriceInput) rentPriceInput.required = true;
                if (rentTenureInput) rentTenureInput.required = true;
                if (priceInput) priceInput.required = false;
            } else {
                rentFields.forEach(field => field.style.display = 'none');
                if (sellPriceField) sellPriceField.style.display = 'block';
                
                // Update required fields
                const rentPriceInput = document.querySelector('input[name="rent_price"]');
                const rentTenureInput = document.querySelector('input[name="rent_tenure"]');
                const priceInput = document.querySelector('input[name="price"]');
                
                if (rentPriceInput) rentPriceInput.required = false;
                if (rentTenureInput) rentTenureInput.required = false;
                if (priceInput) priceInput.required = true;
            }
        }

        function toggleFileUpload() {
            const isSoftCopy = document.getElementById('softCopy')?.checked;
            const fileUploadField = document.querySelector('.field-fileupload');
            const documentInput = document.querySelector('input[name="document"]');
            
            if (fileUploadField) {
                fileUploadField.style.display = isSoftCopy ? 'block' : 'none';
            }
            
            if (documentInput) {
                documentInput.required = isSoftCopy;
            }
        }
        function showChatSoldModal() {
            if (!currentListingId) {
                alert('No listing selected');
                return;
            }
            
            document.getElementById('chatListingId').value = currentListingId;
            const modal = new bootstrap.Modal(document.getElementById('chatSoldModal'));
            modal.show();
            
            // Clear previous form data
            document.getElementById('chatBuyerName').value = '';
            document.getElementById('chatBuyerEmail').value = '';
        }

        // Mark as sold from chat
        async function markAsSoldFromChat() {
            const form = document.getElementById('chatSoldForm');
            const formData = new FormData(form);
            const listingId = document.getElementById('chatListingId').value;
            
            try {
                const response = await fetch(`/mark_sold/${listingId}`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Confirmation email sent to buyer successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('chatSoldModal')).hide();
                    
                    // Hide the sold button after marking as sold
                    const soldBtn = document.getElementById('markSoldBtn');
                    if (soldBtn) soldBtn.style.display = 'none';
                } else {
                    alert('Error: ' + (data.message || 'Failed to send confirmation email'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while sending the email');
            }
        }
        // Modern Mobile Menu Functions
        function toggleMobileMenu() {
            const toggler = document.querySelector('.navbar-toggler');
            const navbarCollapse = document.getElementById('navbarNav');
            const backdrop = document.querySelector('.mobile-menu-backdrop');
            
            toggler.classList.toggle('active');
            navbarCollapse.classList.toggle('show');
            backdrop.classList.toggle('show');
            document.body.classList.toggle('menu-open');
        }

        function closeMobileMenu() {
            const toggler = document.querySelector('.navbar-toggler');
            const navbarCollapse = document.getElementById('navbarNav');
            const backdrop = document.querySelector('.mobile-menu-backdrop');
            
            toggler.classList.remove('active');
            navbarCollapse.classList.remove('show');
            backdrop.classList.remove('show');
            document.body.classList.remove('menu-open');
        }

        // Initialize mobile menu
        document.addEventListener('DOMContentLoaded', function() {
            // Create backdrop
            if (!document.querySelector('.mobile-menu-backdrop')) {
                const backdrop = document.createElement('div');
                backdrop.className = 'mobile-menu-backdrop';
                backdrop.onclick = closeMobileMenu;
                document.body.appendChild(backdrop);
            }
            
            // Close menu on link clicks
            document.querySelectorAll('#navbarNav .nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    if (!this.classList.contains('dropdown-toggle')) {
                        setTimeout(closeMobileMenu, 300);
                    }
                });
            });
            
            // Update mobile user info
            updateMobileUserInfo();
        });

        // Update mobile menu based on login status
        function updateMobileUserInfo() {
            const userName = document.getElementById('userName')?.textContent;
            const mobileUserSection = document.getElementById('mobileUserSection');
            const mobileAuthSection = document.getElementById('mobileAuthSection');
            
            if (userName && userName.trim()) {
                // User is logged in
                mobileUserSection?.classList.remove('d-none');
                if (mobileAuthSection) mobileAuthSection.style.display = 'none';
                
                document.getElementById('mobileUserName').textContent = userName;
                document.getElementById('mobileUserAvatar').textContent = userName.charAt(0).toUpperCase();
            } else {
                // User is logged out
                mobileUserSection?.classList.add('d-none');
                if (mobileAuthSection) mobileAuthSection.style.display = 'flex';
            }
        }

    </script>
</body>
</html>